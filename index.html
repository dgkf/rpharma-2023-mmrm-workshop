<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.3.450">

  <meta name="author" content="Daniel Sabanés Bové, Doug Kelkhoff (Roche)">
  <meta name="dcterms.date" content="2023-10-19">
  <title>R/Pharma mmrm Workshop - From the statistical method to the R package - the mmrm example</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    margin-bottom: 0.5rem;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">From the statistical method to the R package - the <code>mmrm</code> example</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Daniel Sabanés Bové, Doug Kelkhoff (Roche) 
</div>
        <p class="quarto-title-affiliation">
            R/Pharma Workshop
          </p>
    </div>
</div>

  <p class="date">October 19, 2023</p>
</section>
<section id="what-we-will-cover-today" class="slide level2">
<h2>What we will cover today</h2>
<ul>
<li>Show practical steps for obtaining an R package implementation of a statistical method
<ul>
<li>Discuss key considerations for writing statistical software</li>
<li>Illustrate throughout with the <code>mmrm</code> package development example</li>
</ul></li>
<li>Short hands-on introduction to the <code>mmrm</code> package
<ul>
<li>Working together across companies and in open source</li>
</ul></li>
</ul>
</section>
<section>
<section id="key-considerations-for-writing-statistical-r-packages" class="title-slide slide level1 center">
<h1>Key considerations for writing statistical R packages</h1>

</section>
<section id="why-does-this-matter-in-pharma" class="slide level2">
<h2>Why does this matter in Pharma?</h2>
<p>“<em>The credibility</em> of the numerical results of the analysis <em>depends on the quality and validity of the methods and software</em> (both internally and externally written) used both for data management […] and also <em>for processing the data statistically</em>. […] The <em>computer software</em> used for data management and statistical analysis <em>should be reliable</em>, and documentation of <em>appropriate software testing</em> procedures should be available.”</p>
<p>[ICH Topic E 9: Statistical Principles for Clinical Trials, Section 5.8: Integrity of Data and Computer Software Validity]</p>
</section>
<section id="how-can-we-achive-this" class="slide level2">
<h2>How can we achive this?</h2>
<p>How can we implement statistical methods in R such that</p>
<ul>
<li>the software is reliable and</li>
<li>includes appropriate testing</li>
</ul>
<p>to ensure</p>
<ul>
<li>high quality and</li>
<li>validity</li>
</ul>
<p>and ultimately credibility of the statistical analysis results?</p>
</section>
<section id="take-away-lessons-for-writing-statistical-software" class="slide level2">
<h2>Take away lessons for writing statistical software</h2>
<ol type="1">
<li>Choose the right methods and understand them.</li>
<li>Solve the core implementation problem with prototype code.</li>
<li>Spend enough time on planning the design of the R package.</li>
<li>Assume that your R package will be evolving for a long time.</li>
</ol>
</section></section>
<section>
<section id="choose-the-right-methods-and-understand-them" class="title-slide slide level1 center">
<h1>Choose the right methods and understand them</h1>

</section>
<section id="why-is-this-important" class="slide level2">
<h2>Why is this important?</h2>
<p>“<em>The credibility</em> of the numerical results of the analysis <em>depends on the quality and validity of the methods</em> and software …”</p>
<ul>
<li>If we don’t choose the right method, then the best software implementation of it won’t help the credibility of the statistical analysis!</li>
<li>Work together with methods experts (internal, external, …)</li>
</ul>
</section>
<section id="how-can-we-understand-the-statistical-method" class="slide level2">
<h2>How can we understand the statistical method?</h2>
<p>We need to understand the method before implementing it!</p>
<ul>
<li>It is not sufficient to just copy/paste code from methods experts</li>
<li>Let the methods experts present a summary of the methods</li>
<li>Read an overview paper about the methods</li>
<li>Paraphrase and ask lots of clarifying questions</li>
<li>Understand the details by reading the original paper describing the method</li>
</ul>
</section>
<section id="example-mmrm" class="slide level2">
<h2>Example: <code>mmrm</code></h2>
<ul>
<li>Understand the acronym: Mixed Model with Repeated Measures</li>
<li>Understand the method: It is <em>not</em> a mixed model, just a general linear model
<ul>
<li>Read an overview paper</li>
</ul></li>
<li>Understand the problem: In R we did not get the correct adjusted degrees of freedom
<ul>
<li>Try out existing R packages and compare results with proprietary software</li>
<li>Read paper describing the adjusted degrees of freedom</li>
</ul></li>
</ul>
</section>
<section id="example-mmrm-fast-forward" class="slide level2">
<h2>Example: <code>mmrm</code> (fast forward)</h2>
<ul>
<li>Initial implementation with <code>lme4</code> workaround (see previous R/Pharma presentation)</li>
<li>Works only quite ok for small data sets with few time points</li>
<li>Does not converge and takes hours on large data sets with many time points</li>
<li>Therefore needed to look for another solution</li>
</ul>
</section></section>
<section>
<section id="solve-the-core-implementation-problem-with-prototype-code" class="title-slide slide level1 center">
<h1>Solve the core implementation problem with prototype code</h1>

</section>
<section id="what-is-prototype-code" class="slide level2">
<h2>What is prototype code?</h2>
<ul>
<li>Can come in different forms, but
<ul>
<li>is not an R package yet,</li>
<li>not documented with <code>roxygen2</code>,</li>
<li>not unit tested</li>
</ul></li>
<li>It works usually quite well to have an <code>Rmd</code> or <code>qmd</code> document to combine thoughts and code</li>
<li>Typically an R script from a methods expert that implements the method can be the start for a prototype</li>
</ul>
</section>
<section id="when-have-you-solved-the-core-implementation-problem" class="slide level2">
<h2>When have you solved the core implementation problem?</h2>
<ul>
<li>You have R code that allows you to (half-manually) calculate the results with the chosen methods</li>
<li>Different methods options have been elicited from experts, considered and could be used</li>
<li>You have evaluated different solution paths (e.g.&nbsp;using package A or package B as a backbone)</li>
<li>You feel that you have solved the hardest part of the problem - everything else is clear how to do it</li>
<li>(If possible) You have compared the numerical results from your R code with other software, and they match up to numerical accuracy (e.g.&nbsp;relative difference of 0.001)</li>
</ul>
</section>
<section id="example-mmrm---try-to-use-existing-packages" class="slide level2">
<h2>Example: <code>mmrm</code> - try to use existing packages</h2>
<ul>
<li>The hardest part: adjusted degrees of freedom calculation</li>
<li>Tried different solutions with existing R packages:
<ul>
<li>using package <code>nlme</code> with <code>emmeans</code> (results are too different, calculation is too approximate)</li>
<li>using package <code>lme4</code> with <code>lmerTest</code> (fails on large data sets with many time points)</li>
<li>using package <code>glmmTMB</code> (does not have adjusted degrees of freedom)ß</li>
</ul></li>
</ul>
</section>
<section id="example-mmrm---try-to-extend-existing-package" class="slide level2">
<h2>Example: <code>mmrm</code> - try to extend existing package</h2>
<p>Tried to extend <code>glmmTMB</code> to calculate Satterthwaite adjusted degrees of freedom:</p>
<ul>
<li>Got in touch with <code>glmmTMB</code> authors and Ben Bolker provided great help and assistance</li>
<li>Unfortunately it did not work out (results were very far off for unstructed covariance)</li>
<li>Understand that <code>glmmTMB</code> always uses a random effects model representation which is not what we want</li>
</ul>
</section>
<section id="example-mmrm---try-to-make-a-custom-implementation" class="slide level2">
<h2>Example: <code>mmrm</code> - try to make a custom implementation</h2>
<p>Idea was then to use the Template Model Builder (<code>TMB</code>) library directly:</p>
<ul>
<li>As the name suggests, <code>TMB</code> is also used by <code>glmmTMB</code> as the backend</li>
<li>We can code with <code>C++</code> the likelihood of the model we exactly need (general linear model without random effects)</li>
<li>The magic: <code>TMB</code> allows to automatically differentiate the (log) likelihood (i.e.&nbsp;by compiling the <code>C++</code> code)</li>
<li>The gradient (and Hessian) can then be used from the R side to find the (restricted) maximum likelihood estimates</li>
<li>Within a long weekend, got a working prototype that was fast and matched proprietary software results nicely</li>
</ul>
</section></section>
<section>
<section id="spend-enough-time-on-planning-the-design-of-the-r-package" class="title-slide slide level1 center">
<h1>Spend enough time on planning the design of the R-package</h1>

</section>
<section id="why-not-jump-into-writing-functions-right-away" class="slide level2">
<h2>Why not jump into writing functions right away?</h2>
<ul>
<li>Need to see the “big picture” first to know how each piece should look like
<ul>
<li>Including definition of the scope of the package - what should be included vs.&nbsp;not</li>
<li>Important to discuss “big picture” plan with experts and users regarding workflow</li>
</ul></li>
<li>When writing a function you should do it together with documentation and unit tests
<ul>
<li>If you just start somewhere, chances are very high that you will need to change it later</li>
</ul></li>
</ul>
</section>
<section id="how-to-plan-the-design-of-the-r-package" class="slide level2">
<h2>How to plan the design of the R-package?</h2>
<ol type="1">
<li>Start with blank sheet of paper to draw flow diagram
<ul>
<li>What parts (functions and classes) can represent the problem most naturally?</li>
</ul></li>
<li>Draft a bit more details in doc
<ul>
<li>Which arguments for functions, which slots for classes? Names?</li>
</ul></li>
<li>Go into <code>Rmd</code> design document and draft prototypes for functions and classes</li>
<li>Break down design into separate issues (tasks) to implement
<ul>
<li>Make notes of dependencies and resulting order of implementation</li>
</ul></li>
</ol>
</section>
<section id="example-mmrm-1" class="slide level2">
<h2>Example: <code>mmrm</code></h2>
<ul>
<li>Have a single <code>Rmd</code> as initial design document including prototypes</li>
</ul>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="sc">---</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>title<span class="sc">:</span> <span class="st">"Design for fitting MMRM"</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>author<span class="sc">:</span> <span class="st">"Daniel Sabanes Bove"</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>output<span class="sc">:</span> html_document</span>
<span id="cb1-5"><a href="#cb1-5"></a>editor_options<span class="sc">:</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>  chunk_output_type<span class="sc">:</span> console</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="sc">---</span></span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="st">```</span><span class="at">{r setup, include=FALSE}</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="at">knitr::opts_chunk$set(echo = TRUE)</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="st">```</span></span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co"># Objective</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a>We would like to prototype the whole flow of fitting an MMRM <span class="cf">in</span> this new package.</span>
<span id="cb1-16"><a href="#cb1-16"></a>This will make subsequent issue solutions more efficient.</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="st">```</span><span class="at">{r}</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="at">library(mmrm)</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="at">library(checkmate)</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="at">library(glmmTMB)</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="st">```</span></span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co"># Example</span></span>
<span id="cb1-25"><a href="#cb1-25"></a></span>
<span id="cb1-26"><a href="#cb1-26"></a>Let<span class="st">'s first set up some example.</span></span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="st">```{r}</span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="st">dat &lt;- fev_data</span></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="st">vs &lt;- list(</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="st">  response = "FEV1",</span></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="st">  covariates = c("RACE", "SEX"),</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="st">  id = "USUBJID",</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="st">  arm = "ARMCD",</span></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="st">  visit = "AVISIT"</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="st">)</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="st">```</span></span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="st"># Prototypes</span></span>
<span id="cb1-40"><a href="#cb1-40"></a></span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="st">## `check_vars()` --&gt; `h_labels()` and `assert_data()`</span></span>
<span id="cb1-42"><a href="#cb1-42"></a></span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="st">We try to simplify the function compared to the old code, using external helpers</span></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="st">and splitting up the function.</span></span>
<span id="cb1-45"><a href="#cb1-45"></a></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="st">```{r}</span></span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="st">h_is_specified &lt;- function(x, vars) {</span></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="st">  !is.null(vars[[x]])</span></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="st">}</span></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="st">h_is_specified_and_in_data &lt;- function(x, vars, data) {</span></span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="st">  h_is_specified(x, vars) &amp;&amp; all(vars[[x]] %in% names(data))</span></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="st">}</span></span>
<span id="cb1-53"><a href="#cb1-53"></a><span class="st">h_check_and_get_label &lt;- function(x, vars, data) {</span></span>
<span id="cb1-54"><a href="#cb1-54"></a><span class="st">  assert_true(h_is_specified_and_in_data(x, vars, data))</span></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="st">  res &lt;- NULL</span></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="st">  for (v in vars[[x]]) {</span></span>
<span id="cb1-57"><a href="#cb1-57"></a><span class="st">    label &lt;- attr(data[[v]], "label")</span></span>
<span id="cb1-58"><a href="#cb1-58"></a><span class="st">    string &lt;- ifelse(!is.null(label), label, v)</span></span>
<span id="cb1-59"><a href="#cb1-59"></a><span class="st">    res &lt;- c(res, stats::setNames(string, v))</span></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="st">  }</span></span>
<span id="cb1-61"><a href="#cb1-61"></a><span class="st">  res</span></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="st">}</span></span>
<span id="cb1-63"><a href="#cb1-63"></a><span class="st">h_get_covariate_parts &lt;- function(covariates) {</span></span>
<span id="cb1-64"><a href="#cb1-64"></a><span class="st">  unique(unlist(strsplit(covariates, split = "</span><span class="sc">\\</span><span class="st">*|:")))</span></span>
<span id="cb1-65"><a href="#cb1-65"></a><span class="st">}</span></span>
<span id="cb1-66"><a href="#cb1-66"></a><span class="st">```</span></span>
<span id="cb1-67"><a href="#cb1-67"></a></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="st">Let'</span>s quickly try these out<span class="sc">:</span></span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="st">```</span><span class="at">{r}</span></span>
<span id="cb1-71"><a href="#cb1-71"></a><span class="at">h_check_and_get_label("arm", vs, dat)</span></span>
<span id="cb1-72"><a href="#cb1-72"></a><span class="st">```</span></span>
<span id="cb1-73"><a href="#cb1-73"></a></span>
<span id="cb1-74"><a href="#cb1-74"></a>Let<span class="st">'s have a separate `h_labels()` function. This is mostly checking</span></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="st">the variable specifications on the side, too.</span></span>
<span id="cb1-76"><a href="#cb1-76"></a></span>
<span id="cb1-77"><a href="#cb1-77"></a><span class="st">```{r}</span></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="st">h_labels &lt;- function(vars,</span></span>
<span id="cb1-79"><a href="#cb1-79"></a><span class="st">                     data) {</span></span>
<span id="cb1-80"><a href="#cb1-80"></a><span class="st">  assert_list(vars)</span></span>
<span id="cb1-81"><a href="#cb1-81"></a><span class="st">  assert_data_frame(data)</span></span>
<span id="cb1-82"><a href="#cb1-82"></a></span>
<span id="cb1-83"><a href="#cb1-83"></a><span class="st">  labels &lt;- list()</span></span>
<span id="cb1-84"><a href="#cb1-84"></a></span>
<span id="cb1-85"><a href="#cb1-85"></a><span class="st">  labels$response &lt;- h_check_and_get_label("response", vars, data)</span></span>
<span id="cb1-86"><a href="#cb1-86"></a><span class="st">  labels$id &lt;- h_check_and_get_label("id", vars, data)</span></span>
<span id="cb1-87"><a href="#cb1-87"></a><span class="st">  labels$visit &lt;- h_check_and_get_label("visit", vars, data)</span></span>
<span id="cb1-88"><a href="#cb1-88"></a><span class="st">  if (h_is_specified("arm", vars)) {</span></span>
<span id="cb1-89"><a href="#cb1-89"></a><span class="st">    h_check_and_get_label("arm", vars, data)</span></span>
<span id="cb1-90"><a href="#cb1-90"></a><span class="st">  }</span></span>
<span id="cb1-91"><a href="#cb1-91"></a><span class="st">  if (h_is_specified("covariates", vars)) {</span></span>
<span id="cb1-92"><a href="#cb1-92"></a><span class="st">    vars$parts &lt;- h_get_covariate_parts(vars$covariates)</span></span>
<span id="cb1-93"><a href="#cb1-93"></a><span class="st">    labels$parts &lt;- h_check_and_get_label("parts", vars, data)</span></span>
<span id="cb1-94"><a href="#cb1-94"></a><span class="st">  }</span></span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a><span class="st">  return(labels)</span></span>
<span id="cb1-97"><a href="#cb1-97"></a><span class="st">}</span></span>
<span id="cb1-98"><a href="#cb1-98"></a></span>
<span id="cb1-99"><a href="#cb1-99"></a><span class="st">h_labels(vs, dat)</span></span>
<span id="cb1-100"><a href="#cb1-100"></a><span class="st">```</span></span>
<span id="cb1-101"><a href="#cb1-101"></a></span>
<span id="cb1-102"><a href="#cb1-102"></a><span class="st">Now let'</span>s do the <span class="fu">check</span> (assertion) <span class="cf">function</span> <span class="cf">for</span> the data.</span>
<span id="cb1-103"><a href="#cb1-103"></a>Again let<span class="st">'s brake it down into manageable pieces.</span></span>
<span id="cb1-104"><a href="#cb1-104"></a></span>
<span id="cb1-105"><a href="#cb1-105"></a><span class="st">```{r}</span></span>
<span id="cb1-106"><a href="#cb1-106"></a><span class="st">h_assert_one_rec_pt_visit &lt;- function(vars, data) {</span></span>
<span id="cb1-107"><a href="#cb1-107"></a><span class="st">  # Check there is no more than one record per patient and visit.</span></span>
<span id="cb1-108"><a href="#cb1-108"></a><span class="st">  form &lt;- stats::as.formula(paste("~", vars$visit, "+", vars$id))</span></span>
<span id="cb1-109"><a href="#cb1-109"></a><span class="st">  grouped_data &lt;- split(data, f = form)</span></span>
<span id="cb1-110"><a href="#cb1-110"></a><span class="st">  n_per_group &lt;- vapply(grouped_data, nrow, integer(1))</span></span>
<span id="cb1-111"><a href="#cb1-111"></a></span>
<span id="cb1-112"><a href="#cb1-112"></a><span class="st">  if (any(n_per_group &gt; 1)) {</span></span>
<span id="cb1-113"><a href="#cb1-113"></a><span class="st">    dupl_group &lt;- which(n_per_group &gt; 1)</span></span>
<span id="cb1-114"><a href="#cb1-114"></a><span class="st">    n_dupl &lt;- length(dupl_group)</span></span>
<span id="cb1-115"><a href="#cb1-115"></a><span class="st">    stop(paste(</span></span>
<span id="cb1-116"><a href="#cb1-116"></a><span class="st">      "There are", n_dupl, "subjects with more than one record per visit:",</span></span>
<span id="cb1-117"><a href="#cb1-117"></a><span class="st">      toString(names(n_dupl))</span></span>
<span id="cb1-118"><a href="#cb1-118"></a><span class="st">    ))</span></span>
<span id="cb1-119"><a href="#cb1-119"></a><span class="st">  }</span></span>
<span id="cb1-120"><a href="#cb1-120"></a><span class="st">}</span></span>
<span id="cb1-121"><a href="#cb1-121"></a></span>
<span id="cb1-122"><a href="#cb1-122"></a><span class="st">h_assert_rsp_var &lt;- function(vars, data) {</span></span>
<span id="cb1-123"><a href="#cb1-123"></a><span class="st">  response_values &lt;- data[[vars$response]]</span></span>
<span id="cb1-124"><a href="#cb1-124"></a><span class="st">  assert_numeric(response_values)</span></span>
<span id="cb1-125"><a href="#cb1-125"></a><span class="st">}</span></span>
<span id="cb1-126"><a href="#cb1-126"></a></span>
<span id="cb1-127"><a href="#cb1-127"></a><span class="st">h_assert_visit_var &lt;- function(vars, data) {</span></span>
<span id="cb1-128"><a href="#cb1-128"></a><span class="st">  visit_values &lt;- data[[vars$visit]]</span></span>
<span id="cb1-129"><a href="#cb1-129"></a><span class="st">  assert_factor(visit_values)</span></span>
<span id="cb1-130"><a href="#cb1-130"></a><span class="st">}</span></span>
<span id="cb1-131"><a href="#cb1-131"></a></span>
<span id="cb1-132"><a href="#cb1-132"></a><span class="st">assert_data &lt;- function(vars, data) {</span></span>
<span id="cb1-133"><a href="#cb1-133"></a><span class="st">  assert_list(vars)</span></span>
<span id="cb1-134"><a href="#cb1-134"></a><span class="st">  assert_data_frame(data)</span></span>
<span id="cb1-135"><a href="#cb1-135"></a></span>
<span id="cb1-136"><a href="#cb1-136"></a><span class="st">  # First subset data to observations with complete regressors.</span></span>
<span id="cb1-137"><a href="#cb1-137"></a><span class="st">  regressor_vars &lt;- c(vars$arm, vars$visit, h_get_covariate_parts(vars$covariates))</span></span>
<span id="cb1-138"><a href="#cb1-138"></a><span class="st">  has_complete_regressors &lt;- stats::complete.cases(data[, regressor_vars])</span></span>
<span id="cb1-139"><a href="#cb1-139"></a><span class="st">  data_complete_regressors &lt;- droplevels(data[has_complete_regressors, ])</span></span>
<span id="cb1-140"><a href="#cb1-140"></a></span>
<span id="cb1-141"><a href="#cb1-141"></a><span class="st">  h_assert_one_rec_pt_visit(vars, data_complete_regressors)</span></span>
<span id="cb1-142"><a href="#cb1-142"></a><span class="st">  h_assert_rsp_var(vars, data_complete_regressors)</span></span>
<span id="cb1-143"><a href="#cb1-143"></a><span class="st">  h_assert_visit_var(vars, data_complete_regressors)</span></span>
<span id="cb1-144"><a href="#cb1-144"></a></span>
<span id="cb1-145"><a href="#cb1-145"></a><span class="st">  # Second only look at complete data.</span></span>
<span id="cb1-146"><a href="#cb1-146"></a><span class="st">  has_complete_response &lt;- stats::complete.cases(data_complete_regressors[, vars$response])</span></span>
<span id="cb1-147"><a href="#cb1-147"></a><span class="st">  data_complete &lt;- droplevels(data_complete_regressors[has_complete_response, ])</span></span>
<span id="cb1-148"><a href="#cb1-148"></a></span>
<span id="cb1-149"><a href="#cb1-149"></a><span class="st">  if (h_is_specified("arm", vars)) {</span></span>
<span id="cb1-150"><a href="#cb1-150"></a><span class="st">    assert_factor(data_complete_regressors[[vars$arm]], min.levels = 2L)</span></span>
<span id="cb1-151"><a href="#cb1-151"></a><span class="st">    assert_factor(</span></span>
<span id="cb1-152"><a href="#cb1-152"></a><span class="st">      data_complete[[vars$arm]],</span></span>
<span id="cb1-153"><a href="#cb1-153"></a><span class="st">      levels = levels(data_complete_regressors[[vars$arm]])</span></span>
<span id="cb1-154"><a href="#cb1-154"></a><span class="st">    )</span></span>
<span id="cb1-155"><a href="#cb1-155"></a><span class="st">    assert_true(all(table(data_complete[[vars$arm]]) &gt; 5))</span></span>
<span id="cb1-156"><a href="#cb1-156"></a><span class="st">  } else {</span></span>
<span id="cb1-157"><a href="#cb1-157"></a><span class="st">    assert_data_frame(data_complete, min.rows = 5L)</span></span>
<span id="cb1-158"><a href="#cb1-158"></a><span class="st">  }</span></span>
<span id="cb1-159"><a href="#cb1-159"></a><span class="st">}</span></span>
<span id="cb1-160"><a href="#cb1-160"></a><span class="st">```</span></span>
<span id="cb1-161"><a href="#cb1-161"></a></span>
<span id="cb1-162"><a href="#cb1-162"></a><span class="st">Note that in production the arm checking part could be also put into a</span></span>
<span id="cb1-163"><a href="#cb1-163"></a><span class="st">helper function to make the `assert_data()` function more consistent.</span></span>
<span id="cb1-164"><a href="#cb1-164"></a></span>
<span id="cb1-165"><a href="#cb1-165"></a><span class="st">Now let'</span>s try this out, too.</span>
<span id="cb1-166"><a href="#cb1-166"></a></span>
<span id="cb1-167"><a href="#cb1-167"></a><span class="st">```</span><span class="at">{r}</span></span>
<span id="cb1-168"><a href="#cb1-168"></a><span class="at">assert_data(vs, dat)</span></span>
<span id="cb1-169"><a href="#cb1-169"></a><span class="st">```</span></span>
<span id="cb1-170"><a href="#cb1-170"></a></span>
<span id="cb1-171"><a href="#cb1-171"></a></span>
<span id="cb1-172"><a href="#cb1-172"></a><span class="do">## `h_build_formula()`</span></span>
<span id="cb1-173"><a href="#cb1-173"></a></span>
<span id="cb1-174"><a href="#cb1-174"></a>Let<span class="st">'s build the formula for the `glmmTMB` fit call. Basically we want something</span></span>
<span id="cb1-175"><a href="#cb1-175"></a><span class="st">like this:</span></span>
<span id="cb1-176"><a href="#cb1-176"></a></span>
<span id="cb1-177"><a href="#cb1-177"></a><span class="st">`AVAL ~ STRATA1 + BMRKR2 + ARMCD + ARMCD + AVISIT + ARMCD * AVISIT + us(0 + AVISIT | USUBJID)`</span></span>
<span id="cb1-178"><a href="#cb1-178"></a></span>
<span id="cb1-179"><a href="#cb1-179"></a><span class="st">where the `us` part would look different for covariance structures other than</span></span>
<span id="cb1-180"><a href="#cb1-180"></a><span class="st">this unstructured one.</span></span>
<span id="cb1-181"><a href="#cb1-181"></a></span>
<span id="cb1-182"><a href="#cb1-182"></a><span class="st">For the `cor_struct` argument we keep a bit more higher level syntax than</span></span>
<span id="cb1-183"><a href="#cb1-183"></a><span class="st">`glmmTMB` itself, since e.g. `us` and `cs` could easily be confused by the user.</span></span>
<span id="cb1-184"><a href="#cb1-184"></a></span>
<span id="cb1-185"><a href="#cb1-185"></a><span class="st">Note that for now we don'</span>t put <span class="cf">in</span> the option to have separate covariance matrices</span>
<span id="cb1-186"><a href="#cb1-186"></a>per group yet, we can do this <span class="cf">in</span> a second pass later <span class="fu">on</span> (backlog).</span>
<span id="cb1-187"><a href="#cb1-187"></a></span>
<span id="cb1-188"><a href="#cb1-188"></a><span class="st">```</span><span class="at">{r}</span></span>
<span id="cb1-189"><a href="#cb1-189"></a><span class="at">h_build_formula &lt;- function(vars,</span></span>
<span id="cb1-190"><a href="#cb1-190"></a><span class="at">                            cor_struct = c(</span></span>
<span id="cb1-191"><a href="#cb1-191"></a><span class="at">                              "unstructured",</span></span>
<span id="cb1-192"><a href="#cb1-192"></a><span class="at">                              "toeplitz",</span></span>
<span id="cb1-193"><a href="#cb1-193"></a><span class="at">                              "auto-regressive",</span></span>
<span id="cb1-194"><a href="#cb1-194"></a><span class="at">                              "compound-symmetry"</span></span>
<span id="cb1-195"><a href="#cb1-195"></a><span class="at">                            )) {</span></span>
<span id="cb1-196"><a href="#cb1-196"></a><span class="at">  assert_list(vars)</span></span>
<span id="cb1-197"><a href="#cb1-197"></a><span class="at">  cor_struct &lt;- match.arg(cor_struct)</span></span>
<span id="cb1-198"><a href="#cb1-198"></a></span>
<span id="cb1-199"><a href="#cb1-199"></a><span class="at">  covariates_part &lt;- paste(</span></span>
<span id="cb1-200"><a href="#cb1-200"></a><span class="at">    vars$covariates,</span></span>
<span id="cb1-201"><a href="#cb1-201"></a><span class="at">    collapse = " + "</span></span>
<span id="cb1-202"><a href="#cb1-202"></a><span class="at">  )</span></span>
<span id="cb1-203"><a href="#cb1-203"></a><span class="at">  arm_visit_part &lt;- if (is.null(vars$arm)) {</span></span>
<span id="cb1-204"><a href="#cb1-204"></a><span class="at">    vars$visit</span></span>
<span id="cb1-205"><a href="#cb1-205"></a><span class="at">  } else {</span></span>
<span id="cb1-206"><a href="#cb1-206"></a><span class="at">    paste0(</span></span>
<span id="cb1-207"><a href="#cb1-207"></a><span class="at">      vars$arm,</span></span>
<span id="cb1-208"><a href="#cb1-208"></a><span class="at">      "*",</span></span>
<span id="cb1-209"><a href="#cb1-209"></a><span class="at">      vars$visit</span></span>
<span id="cb1-210"><a href="#cb1-210"></a><span class="at">    )</span></span>
<span id="cb1-211"><a href="#cb1-211"></a><span class="at">  }</span></span>
<span id="cb1-212"><a href="#cb1-212"></a><span class="at">  random_effects_fun &lt;- switch(cor_struct,</span></span>
<span id="cb1-213"><a href="#cb1-213"></a><span class="at">    "unstructured" = "us",</span></span>
<span id="cb1-214"><a href="#cb1-214"></a><span class="at">    "toeplitz" = "toep",</span></span>
<span id="cb1-215"><a href="#cb1-215"></a><span class="at">    "auto-regressive" = "ar1",</span></span>
<span id="cb1-216"><a href="#cb1-216"></a><span class="at">    "compound-symmetry" = "cs"</span></span>
<span id="cb1-217"><a href="#cb1-217"></a><span class="at">  )</span></span>
<span id="cb1-218"><a href="#cb1-218"></a><span class="at">  random_effects_part &lt;- paste0(</span></span>
<span id="cb1-219"><a href="#cb1-219"></a><span class="at">    random_effects_fun, "(0 + ", vars$visit, " | ", vars$id, ")"</span></span>
<span id="cb1-220"><a href="#cb1-220"></a><span class="at">  )</span></span>
<span id="cb1-221"><a href="#cb1-221"></a><span class="at">  rhs_formula &lt;- paste(</span></span>
<span id="cb1-222"><a href="#cb1-222"></a><span class="at">    arm_visit_part,</span></span>
<span id="cb1-223"><a href="#cb1-223"></a><span class="at">    "+",</span></span>
<span id="cb1-224"><a href="#cb1-224"></a><span class="at">    random_effects_part</span></span>
<span id="cb1-225"><a href="#cb1-225"></a><span class="at">  )</span></span>
<span id="cb1-226"><a href="#cb1-226"></a><span class="at">  if (covariates_part != "") {</span></span>
<span id="cb1-227"><a href="#cb1-227"></a><span class="at">    rhs_formula &lt;- paste(</span></span>
<span id="cb1-228"><a href="#cb1-228"></a><span class="at">      covariates_part,</span></span>
<span id="cb1-229"><a href="#cb1-229"></a><span class="at">      "+",</span></span>
<span id="cb1-230"><a href="#cb1-230"></a><span class="at">      rhs_formula</span></span>
<span id="cb1-231"><a href="#cb1-231"></a><span class="at">    )</span></span>
<span id="cb1-232"><a href="#cb1-232"></a><span class="at">  }</span></span>
<span id="cb1-233"><a href="#cb1-233"></a><span class="at">  stats::as.formula(paste(</span></span>
<span id="cb1-234"><a href="#cb1-234"></a><span class="at">    vars$response,</span></span>
<span id="cb1-235"><a href="#cb1-235"></a><span class="at">    "~",</span></span>
<span id="cb1-236"><a href="#cb1-236"></a><span class="at">    rhs_formula</span></span>
<span id="cb1-237"><a href="#cb1-237"></a><span class="at">  ))</span></span>
<span id="cb1-238"><a href="#cb1-238"></a><span class="at">}</span></span>
<span id="cb1-239"><a href="#cb1-239"></a><span class="st">```</span></span>
<span id="cb1-240"><a href="#cb1-240"></a></span>
<span id="cb1-241"><a href="#cb1-241"></a>Let<span class="st">'s try this out:</span></span>
<span id="cb1-242"><a href="#cb1-242"></a></span>
<span id="cb1-243"><a href="#cb1-243"></a><span class="st">```{r}</span></span>
<span id="cb1-244"><a href="#cb1-244"></a><span class="st">h_build_formula(vs, "toeplitz")</span></span>
<span id="cb1-245"><a href="#cb1-245"></a><span class="st">h_build_formula(vs)</span></span>
<span id="cb1-246"><a href="#cb1-246"></a><span class="st">```</span></span>
<span id="cb1-247"><a href="#cb1-247"></a></span>
<span id="cb1-248"><a href="#cb1-248"></a><span class="st">## `h_cov_estimate()`</span></span>
<span id="cb1-249"><a href="#cb1-249"></a></span>
<span id="cb1-250"><a href="#cb1-250"></a><span class="st">Let'</span>s see <span class="cf">if</span> we even need this function.</span>
<span id="cb1-251"><a href="#cb1-251"></a></span>
<span id="cb1-252"><a href="#cb1-252"></a><span class="st">```</span><span class="at">{r}</span></span>
<span id="cb1-253"><a href="#cb1-253"></a><span class="at">mod &lt;- glmmTMB(</span></span>
<span id="cb1-254"><a href="#cb1-254"></a><span class="at">  FEV1 ~ ar1(0 + AVISIT | USUBJID),</span></span>
<span id="cb1-255"><a href="#cb1-255"></a><span class="at">  data = dat,</span></span>
<span id="cb1-256"><a href="#cb1-256"></a><span class="at">  dispformula = ~0,</span></span>
<span id="cb1-257"><a href="#cb1-257"></a><span class="at">  REML = TRUE</span></span>
<span id="cb1-258"><a href="#cb1-258"></a><span class="at">)</span></span>
<span id="cb1-259"><a href="#cb1-259"></a><span class="at">vc &lt;- VarCorr(mod)</span></span>
<span id="cb1-260"><a href="#cb1-260"></a><span class="at">vc$cond[[1]]</span></span>
<span id="cb1-261"><a href="#cb1-261"></a><span class="at">class(mod) &lt;- c("mmrm_fit", "glmmTMB")</span></span>
<span id="cb1-262"><a href="#cb1-262"></a><span class="st">```</span></span>
<span id="cb1-263"><a href="#cb1-263"></a></span>
<span id="cb1-264"><a href="#cb1-264"></a>OK so that is still not super intuitive, so let<span class="st">'s better have the function.</span></span>
<span id="cb1-265"><a href="#cb1-265"></a><span class="st">Especially as we also want to return how many variance parameters</span></span>
<span id="cb1-266"><a href="#cb1-266"></a><span class="st">there are. For backwards compatibility we also return one ID which had the</span></span>
<span id="cb1-267"><a href="#cb1-267"></a><span class="st">maximum number of visits. Maybe later we can remove this again.</span></span>
<span id="cb1-268"><a href="#cb1-268"></a></span>
<span id="cb1-269"><a href="#cb1-269"></a><span class="st">```{r}</span></span>
<span id="cb1-270"><a href="#cb1-270"></a><span class="st">h_cov_estimate &lt;- function(model) {</span></span>
<span id="cb1-271"><a href="#cb1-271"></a><span class="st">  assert_class(model, "mmrm_fit")</span></span>
<span id="cb1-272"><a href="#cb1-272"></a></span>
<span id="cb1-273"><a href="#cb1-273"></a><span class="st">  cov_est &lt;- VarCorr(model)$cond[[1L]]</span></span>
<span id="cb1-274"><a href="#cb1-274"></a><span class="st">  theta &lt;- getME(model, "theta")</span></span>
<span id="cb1-275"><a href="#cb1-275"></a><span class="st">  id_per_obs &lt;- model$modelInfo$reTrms$cond$flist[[1L]]</span></span>
<span id="cb1-276"><a href="#cb1-276"></a><span class="st">  n_visits &lt;- length(model$modelInfo$reTrms$cond$cnms[[1L]])</span></span>
<span id="cb1-277"><a href="#cb1-277"></a><span class="st">  which_id &lt;- which(table(id_per_obs) == n_visits)[1L]</span></span>
<span id="cb1-278"><a href="#cb1-278"></a></span>
<span id="cb1-279"><a href="#cb1-279"></a><span class="st">  structure(</span></span>
<span id="cb1-280"><a href="#cb1-280"></a><span class="st">    cov_est,</span></span>
<span id="cb1-281"><a href="#cb1-281"></a><span class="st">    id = levels(id_per_obs)[which_id],</span></span>
<span id="cb1-282"><a href="#cb1-282"></a><span class="st">    n_parameters = length(theta)</span></span>
<span id="cb1-283"><a href="#cb1-283"></a><span class="st">  )</span></span>
<span id="cb1-284"><a href="#cb1-284"></a><span class="st">}</span></span>
<span id="cb1-285"><a href="#cb1-285"></a></span>
<span id="cb1-286"><a href="#cb1-286"></a><span class="st">str(h_cov_estimate(mod))</span></span>
<span id="cb1-287"><a href="#cb1-287"></a><span class="st">```</span></span>
<span id="cb1-288"><a href="#cb1-288"></a></span>
<span id="cb1-289"><a href="#cb1-289"></a><span class="st">Here we also get the standard deviations and the correlation matrix as</span></span>
<span id="cb1-290"><a href="#cb1-290"></a><span class="st">attributes but that seems useful.</span></span>
<span id="cb1-291"><a href="#cb1-291"></a></span>
<span id="cb1-292"><a href="#cb1-292"></a><span class="st">## `h_record_all_output()`</span></span>
<span id="cb1-293"><a href="#cb1-293"></a></span>
<span id="cb1-294"><a href="#cb1-294"></a><span class="st">This is direct copy, and then slightly modified, from `rbmi`.</span></span>
<span id="cb1-295"><a href="#cb1-295"></a><span class="st">Therefore we need to include its author (Craig) as contributors in `mmrm`.</span></span>
<span id="cb1-296"><a href="#cb1-296"></a></span>
<span id="cb1-297"><a href="#cb1-297"></a><span class="st">```{r}</span></span>
<span id="cb1-298"><a href="#cb1-298"></a><span class="st">#'</span> Capture all Output</span>
<span id="cb1-299"><a href="#cb1-299"></a><span class="co">#'</span></span>
<span id="cb1-300"><a href="#cb1-300"></a><span class="co">#' This function silences all warnings, errors &amp; messages and instead returns a list</span></span>
<span id="cb1-301"><a href="#cb1-301"></a><span class="co">#' containing the results (if it didn't error) + the warning and error messages as</span></span>
<span id="cb1-302"><a href="#cb1-302"></a><span class="co">#' character vectors.</span></span>
<span id="cb1-303"><a href="#cb1-303"></a><span class="co">#'</span></span>
<span id="cb1-304"><a href="#cb1-304"></a><span class="co">#' @param expr (`expression`)\cr to be executed.</span></span>
<span id="cb1-305"><a href="#cb1-305"></a><span class="co">#' @param remove (`list`)\cr optional list with elements `warnings`, `errors`,</span></span>
<span id="cb1-306"><a href="#cb1-306"></a><span class="co">#'   `messages` which can be character vectors, which will be removed from the</span></span>
<span id="cb1-307"><a href="#cb1-307"></a><span class="co">#'   results if specified.</span></span>
<span id="cb1-308"><a href="#cb1-308"></a><span class="co">#'</span></span>
<span id="cb1-309"><a href="#cb1-309"></a><span class="co">#' @return</span></span>
<span id="cb1-310"><a href="#cb1-310"></a><span class="co">#' A list containing</span></span>
<span id="cb1-311"><a href="#cb1-311"></a><span class="co">#'</span></span>
<span id="cb1-312"><a href="#cb1-312"></a><span class="co">#' - `result`: The object returned by `expr` or `list()` if an error was thrown</span></span>
<span id="cb1-313"><a href="#cb1-313"></a><span class="co">#' - `warnings`: `NULL` or a character vector if warnings were thrown.</span></span>
<span id="cb1-314"><a href="#cb1-314"></a><span class="co">#' - `errors`: `NULL` or a string if an error was thrown.</span></span>
<span id="cb1-315"><a href="#cb1-315"></a><span class="co">#' - `messages`: `NULL` or a character vector if messages were produced.</span></span>
<span id="cb1-316"><a href="#cb1-316"></a><span class="co">#'</span></span>
<span id="cb1-317"><a href="#cb1-317"></a><span class="co">#' @examples</span></span>
<span id="cb1-318"><a href="#cb1-318"></a><span class="co">#' \dontrun{</span></span>
<span id="cb1-319"><a href="#cb1-319"></a><span class="co">#' h_record_all_output({</span></span>
<span id="cb1-320"><a href="#cb1-320"></a><span class="co">#'   x &lt;- 1</span></span>
<span id="cb1-321"><a href="#cb1-321"></a><span class="co">#'   y &lt;- 2</span></span>
<span id="cb1-322"><a href="#cb1-322"></a><span class="co">#'   warning("something went wrong")</span></span>
<span id="cb1-323"><a href="#cb1-323"></a><span class="co">#'   message("O nearly done")</span></span>
<span id="cb1-324"><a href="#cb1-324"></a><span class="co">#'   x + y</span></span>
<span id="cb1-325"><a href="#cb1-325"></a><span class="co">#' })</span></span>
<span id="cb1-326"><a href="#cb1-326"></a><span class="co">#' }</span></span>
<span id="cb1-327"><a href="#cb1-327"></a>h_record_all_output <span class="ot">&lt;-</span> <span class="cf">function</span>(expr, <span class="at">remove =</span> <span class="fu">list</span>()) {</span>
<span id="cb1-328"><a href="#cb1-328"></a>  <span class="co"># Note: We don't need to and cannot assert `expr` here.</span></span>
<span id="cb1-329"><a href="#cb1-329"></a>  <span class="fu">assert_list</span>(remove)</span>
<span id="cb1-330"><a href="#cb1-330"></a></span>
<span id="cb1-331"><a href="#cb1-331"></a>  env <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb1-332"><a href="#cb1-332"></a>  result <span class="ot">&lt;-</span> <span class="fu">withCallingHandlers</span>(</span>
<span id="cb1-333"><a href="#cb1-333"></a>    <span class="fu">withRestarts</span>(</span>
<span id="cb1-334"><a href="#cb1-334"></a>      expr,</span>
<span id="cb1-335"><a href="#cb1-335"></a>      <span class="at">muffleStop =</span> <span class="cf">function</span>() <span class="fu">list</span>()</span>
<span id="cb1-336"><a href="#cb1-336"></a>    ),</span>
<span id="cb1-337"><a href="#cb1-337"></a>    <span class="at">message =</span> <span class="cf">function</span>(m) {</span>
<span id="cb1-338"><a href="#cb1-338"></a>      msg_without_newline <span class="ot">&lt;-</span> <span class="fu">gsub</span>(m<span class="sc">$</span>message, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">$"</span>, <span class="at">replacement =</span> <span class="st">""</span>)</span>
<span id="cb1-339"><a href="#cb1-339"></a>      env<span class="sc">$</span>message <span class="ot">&lt;-</span> <span class="fu">c</span>(env<span class="sc">$</span>message, msg_without_newline)</span>
<span id="cb1-340"><a href="#cb1-340"></a>      <span class="fu">invokeRestart</span>(<span class="st">"muffleMessage"</span>)</span>
<span id="cb1-341"><a href="#cb1-341"></a>    },</span>
<span id="cb1-342"><a href="#cb1-342"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w) {</span>
<span id="cb1-343"><a href="#cb1-343"></a>      env<span class="sc">$</span>warning <span class="ot">&lt;-</span> <span class="fu">c</span>(env<span class="sc">$</span>warning, w<span class="sc">$</span>message)</span>
<span id="cb1-344"><a href="#cb1-344"></a>      <span class="fu">invokeRestart</span>(<span class="st">"muffleWarning"</span>)</span>
<span id="cb1-345"><a href="#cb1-345"></a>    },</span>
<span id="cb1-346"><a href="#cb1-346"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb1-347"><a href="#cb1-347"></a>      env<span class="sc">$</span>error <span class="ot">&lt;-</span> <span class="fu">c</span>(env<span class="sc">$</span>error, e<span class="sc">$</span>message)</span>
<span id="cb1-348"><a href="#cb1-348"></a>      <span class="fu">invokeRestart</span>(<span class="st">"muffleStop"</span>)</span>
<span id="cb1-349"><a href="#cb1-349"></a>    }</span>
<span id="cb1-350"><a href="#cb1-350"></a>  )</span>
<span id="cb1-351"><a href="#cb1-351"></a>  <span class="fu">list</span>(</span>
<span id="cb1-352"><a href="#cb1-352"></a>    <span class="at">result =</span> result,</span>
<span id="cb1-353"><a href="#cb1-353"></a>    <span class="at">warnings =</span> <span class="fu">setdiff</span>(env<span class="sc">$</span>warning, remove<span class="sc">$</span>warnings),</span>
<span id="cb1-354"><a href="#cb1-354"></a>    <span class="at">errors =</span> <span class="fu">setdiff</span>(env<span class="sc">$</span>error, remove<span class="sc">$</span>errors),</span>
<span id="cb1-355"><a href="#cb1-355"></a>    <span class="at">messages =</span> <span class="fu">setdiff</span>(env<span class="sc">$</span>message, remove<span class="sc">$</span>messages)</span>
<span id="cb1-356"><a href="#cb1-356"></a>  )</span>
<span id="cb1-357"><a href="#cb1-357"></a>}</span>
<span id="cb1-358"><a href="#cb1-358"></a></span>
<span id="cb1-359"><a href="#cb1-359"></a><span class="fu">h_record_all_output</span>(</span>
<span id="cb1-360"><a href="#cb1-360"></a>  {</span>
<span id="cb1-361"><a href="#cb1-361"></a>    x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-362"><a href="#cb1-362"></a>    y <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb1-363"><a href="#cb1-363"></a>    <span class="fu">warning</span>(<span class="st">"something went wrong"</span>)</span>
<span id="cb1-364"><a href="#cb1-364"></a>    <span class="fu">message</span>(<span class="st">"O nearly done"</span>)</span>
<span id="cb1-365"><a href="#cb1-365"></a>    <span class="fu">message</span>(<span class="st">"Almost done"</span>)</span>
<span id="cb1-366"><a href="#cb1-366"></a>    x <span class="sc">+</span> y</span>
<span id="cb1-367"><a href="#cb1-367"></a>  },</span>
<span id="cb1-368"><a href="#cb1-368"></a>  <span class="at">remove =</span> <span class="fu">list</span>(<span class="at">messages =</span> <span class="fu">c</span>(<span class="st">"Almost done"</span>, <span class="st">"bla"</span>))</span>
<span id="cb1-369"><a href="#cb1-369"></a>)</span>
<span id="cb1-370"><a href="#cb1-370"></a><span class="st">```</span></span>
<span id="cb1-371"><a href="#cb1-371"></a></span>
<span id="cb1-372"><a href="#cb1-372"></a></span>
<span id="cb1-373"><a href="#cb1-373"></a><span class="at">## </span><span class="st">`</span><span class="fu">fit_single_optimizer</span>()<span class="st">`</span></span>
<span id="cb1-374"><a href="#cb1-374"></a></span>
<span id="cb1-375"><a href="#cb1-375"></a><span class="at">Here the optimizers are possible multivariate ones for </span><span class="st">`</span>stats<span class="sc">::</span><span class="fu">optim</span>()<span class="st">`</span><span class="at">, with</span></span>
<span id="cb1-376"><a href="#cb1-376"></a><span class="at">the default changed to </span><span class="st">`</span>L<span class="sc">-</span>BFGS<span class="sc">-</span>B<span class="st">`</span><span class="at">. Note that we removed the </span><span class="st">`</span>SANN<span class="st">`</span><span class="at"> option since</span></span>
<span id="cb1-377"><a href="#cb1-377"></a><span class="at">that needs very long computation times, so does not seem practical.</span></span>
<span id="cb1-378"><a href="#cb1-378"></a></span>
<span id="cb1-379"><a href="#cb1-379"></a><span class="at">We provide the new possibility for starting values.</span></span>
<span id="cb1-380"><a href="#cb1-380"></a></span>
<span id="cb1-381"><a href="#cb1-381"></a><span class="at">While this function is not the primary user interface, it can be helpful for users.</span></span>
<span id="cb1-382"><a href="#cb1-382"></a><span class="at">Therefore we don't prefix with </span><span class="st">`</span>h_<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-383"><a href="#cb1-383"></a></span>
<span id="cb1-384"><a href="#cb1-384"></a><span class="st">```</span>{r}</span>
<span id="cb1-385"><a href="#cb1-385"></a>fit_single_optimizer <span class="ot">&lt;-</span> <span class="cf">function</span>(formula,</span>
<span id="cb1-386"><a href="#cb1-386"></a>                                 data,</span>
<span id="cb1-387"><a href="#cb1-387"></a>                                 <span class="at">start =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-388"><a href="#cb1-388"></a>                                 <span class="at">optimizer =</span> <span class="fu">c</span>(<span class="st">"L-BFGS-B"</span>, <span class="st">"Nelder-Mead"</span>, <span class="st">"BFGS"</span>, <span class="st">"CG"</span>)) {</span>
<span id="cb1-389"><a href="#cb1-389"></a>  <span class="fu">assert_formula</span>(formula)</span>
<span id="cb1-390"><a href="#cb1-390"></a>  <span class="fu">assert_data_frame</span>(data)</span>
<span id="cb1-391"><a href="#cb1-391"></a>  <span class="fu">assert_list</span>(start, <span class="at">null.ok =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-392"><a href="#cb1-392"></a>  optimizer <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(optimizer)</span>
<span id="cb1-393"><a href="#cb1-393"></a></span>
<span id="cb1-394"><a href="#cb1-394"></a>  control <span class="ot">&lt;-</span> glmmTMB<span class="sc">::</span><span class="fu">glmmTMBControl</span>(</span>
<span id="cb1-395"><a href="#cb1-395"></a>    <span class="at">optimizer =</span> stats<span class="sc">::</span>optim,</span>
<span id="cb1-396"><a href="#cb1-396"></a>    <span class="at">optArgs =</span> <span class="fu">list</span>(<span class="at">method =</span> optimizer),</span>
<span id="cb1-397"><a href="#cb1-397"></a>    <span class="at">parallel =</span> 1L</span>
<span id="cb1-398"><a href="#cb1-398"></a>  )</span>
<span id="cb1-399"><a href="#cb1-399"></a>  quiet_fit <span class="ot">&lt;-</span> <span class="fu">h_record_all_output</span>(</span>
<span id="cb1-400"><a href="#cb1-400"></a>    glmmTMB<span class="sc">::</span><span class="fu">glmmTMB</span>(</span>
<span id="cb1-401"><a href="#cb1-401"></a>      <span class="at">formula =</span> formula,</span>
<span id="cb1-402"><a href="#cb1-402"></a>      <span class="at">data =</span> data,</span>
<span id="cb1-403"><a href="#cb1-403"></a>      <span class="at">dispformula =</span> <span class="sc">~</span><span class="dv">0</span>,</span>
<span id="cb1-404"><a href="#cb1-404"></a>      <span class="at">REML =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-405"><a href="#cb1-405"></a>      <span class="at">start =</span> start,</span>
<span id="cb1-406"><a href="#cb1-406"></a>      <span class="at">control =</span> control</span>
<span id="cb1-407"><a href="#cb1-407"></a>    ),</span>
<span id="cb1-408"><a href="#cb1-408"></a>    <span class="at">remove =</span> <span class="fu">list</span>(</span>
<span id="cb1-409"><a href="#cb1-409"></a>      <span class="at">warnings =</span> <span class="fu">c</span>(</span>
<span id="cb1-410"><a href="#cb1-410"></a>        <span class="st">"OpenMP not supported."</span>,</span>
<span id="cb1-411"><a href="#cb1-411"></a>        <span class="st">"'giveCsparse' has been deprecated; setting 'repr = </span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">' for you"</span></span>
<span id="cb1-412"><a href="#cb1-412"></a>      )</span>
<span id="cb1-413"><a href="#cb1-413"></a>    )</span>
<span id="cb1-414"><a href="#cb1-414"></a>  )</span>
<span id="cb1-415"><a href="#cb1-415"></a>  converged <span class="ot">&lt;-</span> (<span class="fu">length</span>(quiet_fit<span class="sc">$</span>warnings) <span class="sc">==</span> 0L) <span class="sc">&amp;&amp;</span></span>
<span id="cb1-416"><a href="#cb1-416"></a>    (<span class="fu">length</span>(quiet_fit<span class="sc">$</span>errors) <span class="sc">==</span> 0L) <span class="sc">&amp;&amp;</span></span>
<span id="cb1-417"><a href="#cb1-417"></a>    (quiet_fit<span class="sc">$</span>result<span class="sc">$</span>fit<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb1-418"><a href="#cb1-418"></a>  <span class="fu">structure</span>(</span>
<span id="cb1-419"><a href="#cb1-419"></a>    quiet_fit<span class="sc">$</span>result,</span>
<span id="cb1-420"><a href="#cb1-420"></a>    <span class="at">errors =</span> quiet_fit<span class="sc">$</span>errors,</span>
<span id="cb1-421"><a href="#cb1-421"></a>    <span class="at">warnings =</span> quiet_fit<span class="sc">$</span>warnings,</span>
<span id="cb1-422"><a href="#cb1-422"></a>    <span class="at">messages =</span> quiet_fit<span class="sc">$</span>messages,</span>
<span id="cb1-423"><a href="#cb1-423"></a>    <span class="at">optimizer =</span> optimizer,</span>
<span id="cb1-424"><a href="#cb1-424"></a>    <span class="at">converged =</span> converged,</span>
<span id="cb1-425"><a href="#cb1-425"></a>    <span class="at">class =</span> <span class="fu">c</span>(<span class="st">"mmrm_fit"</span>, <span class="fu">class</span>(quiet_fit<span class="sc">$</span>result))</span>
<span id="cb1-426"><a href="#cb1-426"></a>  )</span>
<span id="cb1-427"><a href="#cb1-427"></a>}</span>
<span id="cb1-428"><a href="#cb1-428"></a><span class="st">```</span></span>
<span id="cb1-429"><a href="#cb1-429"></a></span>
<span id="cb1-430"><a href="#cb1-430"></a><span class="at">OK let's try this one out:</span></span>
<span id="cb1-431"><a href="#cb1-431"></a></span>
<span id="cb1-432"><a href="#cb1-432"></a><span class="st">```</span>{r}</span>
<span id="cb1-433"><a href="#cb1-433"></a>mod_fit <span class="ot">&lt;-</span> <span class="fu">fit_single_optimizer</span>(</span>
<span id="cb1-434"><a href="#cb1-434"></a>  <span class="at">formula =</span> <span class="fu">h_build_formula</span>(vs),</span>
<span id="cb1-435"><a href="#cb1-435"></a>  <span class="at">data =</span> dat</span>
<span id="cb1-436"><a href="#cb1-436"></a>)</span>
<span id="cb1-437"><a href="#cb1-437"></a><span class="fu">attr</span>(mod_fit, <span class="st">"converged"</span>)</span>
<span id="cb1-438"><a href="#cb1-438"></a><span class="st">```</span></span>
<span id="cb1-439"><a href="#cb1-439"></a></span>
<span id="cb1-440"><a href="#cb1-440"></a><span class="at">Looks good so far!</span></span>
<span id="cb1-441"><a href="#cb1-441"></a></span>
<span id="cb1-442"><a href="#cb1-442"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_summarize_all_fits</span>()<span class="st">`</span></span>
<span id="cb1-443"><a href="#cb1-443"></a></span>
<span id="cb1-444"><a href="#cb1-444"></a><span class="at">Note that we don't return the fixed effects as that is not used downstream.</span></span>
<span id="cb1-445"><a href="#cb1-445"></a></span>
<span id="cb1-446"><a href="#cb1-446"></a><span class="st">```</span>{r}</span>
<span id="cb1-447"><a href="#cb1-447"></a>h_summarize_all_fits <span class="ot">&lt;-</span> <span class="cf">function</span>(all_fits) {</span>
<span id="cb1-448"><a href="#cb1-448"></a>  <span class="fu">assert_list</span>(all_fits)</span>
<span id="cb1-449"><a href="#cb1-449"></a></span>
<span id="cb1-450"><a href="#cb1-450"></a>  warnings <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_fits, attr, <span class="at">which =</span> <span class="st">"warnings"</span>)</span>
<span id="cb1-451"><a href="#cb1-451"></a>  messages <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_fits, attr, <span class="at">which =</span> <span class="st">"messages"</span>)</span>
<span id="cb1-452"><a href="#cb1-452"></a>  log_liks <span class="ot">&lt;-</span> <span class="fu">vapply</span>(all_fits, stats<span class="sc">::</span>logLik, <span class="fu">numeric</span>(1L))</span>
<span id="cb1-453"><a href="#cb1-453"></a>  converged <span class="ot">&lt;-</span> <span class="fu">vapply</span>(all_fits, attr, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="at">which =</span> <span class="st">"converged"</span>)</span>
<span id="cb1-454"><a href="#cb1-454"></a></span>
<span id="cb1-455"><a href="#cb1-455"></a>  <span class="fu">list</span>(</span>
<span id="cb1-456"><a href="#cb1-456"></a>    <span class="at">warnings =</span> warnings,</span>
<span id="cb1-457"><a href="#cb1-457"></a>    <span class="at">messages =</span> messages,</span>
<span id="cb1-458"><a href="#cb1-458"></a>    <span class="at">log_liks =</span> log_liks,</span>
<span id="cb1-459"><a href="#cb1-459"></a>    <span class="at">converged =</span> converged</span>
<span id="cb1-460"><a href="#cb1-460"></a>  )</span>
<span id="cb1-461"><a href="#cb1-461"></a>}</span>
<span id="cb1-462"><a href="#cb1-462"></a></span>
<span id="cb1-463"><a href="#cb1-463"></a><span class="fu">h_summarize_all_fits</span>(<span class="fu">list</span>(mod_fit, mod_fit))</span>
<span id="cb1-464"><a href="#cb1-464"></a><span class="st">```</span></span>
<span id="cb1-465"><a href="#cb1-465"></a></span>
<span id="cb1-466"><a href="#cb1-466"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_free_cores</span>()<span class="st">`</span></span>
<span id="cb1-467"><a href="#cb1-467"></a></span>
<span id="cb1-468"><a href="#cb1-468"></a><span class="at">This is from the </span><span class="st">`</span>tern.mmrm<span class="st">`</span><span class="at"> package. Since Daniel wrote this function and</span></span>
<span id="cb1-469"><a href="#cb1-469"></a><span class="at">we will take it out of </span><span class="st">`</span>tern.mmrm<span class="st">`</span><span class="at"> before publishing no further author</span></span>
<span id="cb1-470"><a href="#cb1-470"></a><span class="at">implications.</span></span>
<span id="cb1-471"><a href="#cb1-471"></a></span>
<span id="cb1-472"><a href="#cb1-472"></a><span class="at">Note that we will need to add the </span><span class="st">`</span>parallel<span class="st">`</span><span class="at"> and </span><span class="st">`</span>utils<span class="st">`</span><span class="at"> packages to </span><span class="st">`</span>Imports<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-473"><a href="#cb1-473"></a></span>
<span id="cb1-474"><a href="#cb1-474"></a><span class="st">```</span>{r}</span>
<span id="cb1-475"><a href="#cb1-475"></a><span class="co">#' Get an approximate number of free cores.</span></span>
<span id="cb1-476"><a href="#cb1-476"></a><span class="co">#'</span></span>
<span id="cb1-477"><a href="#cb1-477"></a><span class="co">#' @return the approximate number of free cores, which is an integer between 1 and one less than</span></span>
<span id="cb1-478"><a href="#cb1-478"></a><span class="co">#'   the total cores.</span></span>
<span id="cb1-479"><a href="#cb1-479"></a><span class="co">#'</span></span>
<span id="cb1-480"><a href="#cb1-480"></a><span class="co">#' @details This uses the maximum load average at 1, 5 and 15 minutes on Linux and Mac</span></span>
<span id="cb1-481"><a href="#cb1-481"></a><span class="co">#'   machines to approximate the number of busy cores. For Windows, the load percentage is</span></span>
<span id="cb1-482"><a href="#cb1-482"></a><span class="co">#'   multiplied with the total number of cores.</span></span>
<span id="cb1-483"><a href="#cb1-483"></a><span class="co">#'   We then subtract this from the number of all detected cores. One additional core</span></span>
<span id="cb1-484"><a href="#cb1-484"></a><span class="co">#'   is not used for extra safety.</span></span>
<span id="cb1-485"><a href="#cb1-485"></a><span class="co">#'</span></span>
<span id="cb1-486"><a href="#cb1-486"></a><span class="co">#' @noRd</span></span>
<span id="cb1-487"><a href="#cb1-487"></a>h_free_cores <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb1-488"><a href="#cb1-488"></a>  all_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">all.tests =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-489"><a href="#cb1-489"></a>  busy_cores <span class="ot">&lt;-</span></span>
<span id="cb1-490"><a href="#cb1-490"></a>    <span class="cf">if</span> (.Platform<span class="sc">$</span>OS.type <span class="sc">==</span> <span class="st">"windows"</span>) {</span>
<span id="cb1-491"><a href="#cb1-491"></a>      load_percent_string <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"wmic cpu get loadpercentage"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-492"><a href="#cb1-492"></a>      <span class="co"># This gives e.g.: c("LoadPercentage", "10", "")</span></span>
<span id="cb1-493"><a href="#cb1-493"></a>      <span class="co"># So we just take the number here.</span></span>
<span id="cb1-494"><a href="#cb1-494"></a>      load_percent <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">min</span>(load_percent_string[2L], <span class="dv">100</span>))</span>
<span id="cb1-495"><a href="#cb1-495"></a>      <span class="fu">assert_int</span>(load_percent, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">100</span>)</span>
<span id="cb1-496"><a href="#cb1-496"></a>      <span class="fu">ceiling</span>(all_cores <span class="sc">*</span> load_percent <span class="sc">/</span> <span class="dv">100</span>)</span>
<span id="cb1-497"><a href="#cb1-497"></a>    } <span class="cf">else</span> <span class="cf">if</span> (.Platform<span class="sc">$</span>OS.type <span class="sc">==</span> <span class="st">"unix"</span>) {</span>
<span id="cb1-498"><a href="#cb1-498"></a>      uptime_string <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"uptime"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-499"><a href="#cb1-499"></a>      <span class="co"># This gives e.g.:</span></span>
<span id="cb1-500"><a href="#cb1-500"></a>      <span class="co"># "11:00  up  1:57, 3 users, load averages: 2.71 2.64 2.62"</span></span>
<span id="cb1-501"><a href="#cb1-501"></a>      <span class="co"># Here we just want the last three numbers.</span></span>
<span id="cb1-502"><a href="#cb1-502"></a>      uptime_split <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(uptime_string, <span class="at">split =</span> <span class="st">",|</span><span class="sc">\\</span><span class="st">s"</span>)[[<span class="dv">1</span>]] <span class="co"># Split at comma or white space.</span></span>
<span id="cb1-503"><a href="#cb1-503"></a>      uptime_split <span class="ot">&lt;-</span> uptime_split[uptime_split <span class="sc">!=</span> <span class="st">""</span>]</span>
<span id="cb1-504"><a href="#cb1-504"></a>      load_averages <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(utils<span class="sc">::</span><span class="fu">tail</span>(uptime_split, <span class="dv">3</span>))</span>
<span id="cb1-505"><a href="#cb1-505"></a>      <span class="fu">ceiling</span>(<span class="fu">max</span>(load_averages))</span>
<span id="cb1-506"><a href="#cb1-506"></a>    }</span>
<span id="cb1-507"><a href="#cb1-507"></a>  <span class="fu">assert_number</span>(all_cores, <span class="at">lower =</span> <span class="dv">1</span>, <span class="at">finite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-508"><a href="#cb1-508"></a>  <span class="fu">assert_number</span>(busy_cores, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> all_cores)</span>
<span id="cb1-509"><a href="#cb1-509"></a></span>
<span id="cb1-510"><a href="#cb1-510"></a>  <span class="co"># For safety, we subtract 1 more core from all cores.</span></span>
<span id="cb1-511"><a href="#cb1-511"></a>  <span class="fu">as.integer</span>(<span class="fu">max</span>(<span class="dv">1</span>, all_cores <span class="sc">-</span> busy_cores <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb1-512"><a href="#cb1-512"></a>}</span>
<span id="cb1-513"><a href="#cb1-513"></a></span>
<span id="cb1-514"><a href="#cb1-514"></a><span class="fu">h_free_cores</span>()</span>
<span id="cb1-515"><a href="#cb1-515"></a><span class="st">```</span></span>
<span id="cb1-516"><a href="#cb1-516"></a></span>
<span id="cb1-517"><a href="#cb1-517"></a><span class="at">Right now e.g. I have total 16 cores, and I get 14 returned by this function</span></span>
<span id="cb1-518"><a href="#cb1-518"></a><span class="at">which makes sense (1 is busy, and 1 is extra buffer).</span></span>
<span id="cb1-519"><a href="#cb1-519"></a></span>
<span id="cb1-520"><a href="#cb1-520"></a><span class="at">## </span><span class="st">`</span><span class="fu">refit_multiple_optimizers</span>()<span class="st">`</span></span>
<span id="cb1-521"><a href="#cb1-521"></a></span>
<span id="cb1-522"><a href="#cb1-522"></a><span class="st">```</span>{r}</span>
<span id="cb1-523"><a href="#cb1-523"></a>refit_multiple_optimizers <span class="ot">&lt;-</span> <span class="cf">function</span>(fit,</span>
<span id="cb1-524"><a href="#cb1-524"></a>                                      <span class="at">n_cores =</span> 1L,</span>
<span id="cb1-525"><a href="#cb1-525"></a>                                      <span class="at">optimizers =</span> <span class="fu">c</span>(<span class="st">"L-BFGS-B"</span>, <span class="st">"Nelder-Mead"</span>, <span class="st">"BFGS"</span>, <span class="st">"CG"</span>)) {</span>
<span id="cb1-526"><a href="#cb1-526"></a>  <span class="fu">assert_class</span>(fit, <span class="st">"mmrm_fit"</span>)</span>
<span id="cb1-527"><a href="#cb1-527"></a>  <span class="fu">assert_int</span>(n_cores, <span class="at">lower =</span> 1L)</span>
<span id="cb1-528"><a href="#cb1-528"></a>  optimizers <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(optimizers, <span class="at">several.ok =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-529"><a href="#cb1-529"></a></span>
<span id="cb1-530"><a href="#cb1-530"></a>  <span class="co"># Extract the components of the original fit.</span></span>
<span id="cb1-531"><a href="#cb1-531"></a>  old_formula <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">formula</span>(fit)</span>
<span id="cb1-532"><a href="#cb1-532"></a>  old_data <span class="ot">&lt;-</span> fit<span class="sc">$</span>frame</span>
<span id="cb1-533"><a href="#cb1-533"></a>  old_optimizer <span class="ot">&lt;-</span> <span class="fu">attr</span>(fit, <span class="st">"optimizer"</span>)</span>
<span id="cb1-534"><a href="#cb1-534"></a></span>
<span id="cb1-535"><a href="#cb1-535"></a>  <span class="co"># Settings for the new fits.</span></span>
<span id="cb1-536"><a href="#cb1-536"></a>  optimizers <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(optimizers, old_optimizer)</span>
<span id="cb1-537"><a href="#cb1-537"></a>  n_cores_used <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb1-538"><a href="#cb1-538"></a>    .Platform<span class="sc">$</span>OS.type <span class="sc">==</span> <span class="st">"windows"</span>,</span>
<span id="cb1-539"><a href="#cb1-539"></a>    1L,</span>
<span id="cb1-540"><a href="#cb1-540"></a>    <span class="fu">min</span>(</span>
<span id="cb1-541"><a href="#cb1-541"></a>      <span class="fu">length</span>(optimizers),</span>
<span id="cb1-542"><a href="#cb1-542"></a>      n_cores</span>
<span id="cb1-543"><a href="#cb1-543"></a>    )</span>
<span id="cb1-544"><a href="#cb1-544"></a>  )</span>
<span id="cb1-545"><a href="#cb1-545"></a></span>
<span id="cb1-546"><a href="#cb1-546"></a>  all_fits <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(</span>
<span id="cb1-547"><a href="#cb1-547"></a>    <span class="at">X =</span> optimizers,</span>
<span id="cb1-548"><a href="#cb1-548"></a>    <span class="at">FUN =</span> fit_single_optimizer,</span>
<span id="cb1-549"><a href="#cb1-549"></a>    <span class="at">formula =</span> old_formula,</span>
<span id="cb1-550"><a href="#cb1-550"></a>    <span class="at">data =</span> old_data,</span>
<span id="cb1-551"><a href="#cb1-551"></a>    <span class="at">start =</span> <span class="fu">list</span>(<span class="at">theta =</span> fit<span class="sc">$</span>fit<span class="sc">$</span>par), <span class="co"># Take the results from old fit as starting values.</span></span>
<span id="cb1-552"><a href="#cb1-552"></a>    <span class="at">mc.cores =</span> n_cores_used,</span>
<span id="cb1-553"><a href="#cb1-553"></a>    <span class="at">mc.silent =</span> <span class="cn">TRUE</span></span>
<span id="cb1-554"><a href="#cb1-554"></a>  )</span>
<span id="cb1-555"><a href="#cb1-555"></a>  <span class="fu">names</span>(all_fits) <span class="ot">&lt;-</span> optimizers</span>
<span id="cb1-556"><a href="#cb1-556"></a>  all_fits_summary <span class="ot">&lt;-</span> <span class="fu">h_summarize_all_fits</span>(all_fits)</span>
<span id="cb1-557"><a href="#cb1-557"></a></span>
<span id="cb1-558"><a href="#cb1-558"></a>  <span class="co"># Find the results that are ok:</span></span>
<span id="cb1-559"><a href="#cb1-559"></a>  is_ok <span class="ot">&lt;-</span> all_fits_summary<span class="sc">$</span>converged</span>
<span id="cb1-560"><a href="#cb1-560"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(is_ok)) {</span>
<span id="cb1-561"><a href="#cb1-561"></a>    <span class="fu">stop</span>(</span>
<span id="cb1-562"><a href="#cb1-562"></a>      <span class="st">"No optimizer led to a successful model fit. "</span>,</span>
<span id="cb1-563"><a href="#cb1-563"></a>      <span class="st">"Please try to use a different covariance structure or other covariates."</span></span>
<span id="cb1-564"><a href="#cb1-564"></a>    )</span>
<span id="cb1-565"><a href="#cb1-565"></a>  }</span>
<span id="cb1-566"><a href="#cb1-566"></a></span>
<span id="cb1-567"><a href="#cb1-567"></a>  <span class="co"># Return the best result in terms of log-likelihood.</span></span>
<span id="cb1-568"><a href="#cb1-568"></a>  best_optimizer <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">which.max</span>(all_fits_summary<span class="sc">$</span>log_liks[is_ok]))</span>
<span id="cb1-569"><a href="#cb1-569"></a>  best_fit <span class="ot">&lt;-</span> all_fits[[best_optimizer]]</span>
<span id="cb1-570"><a href="#cb1-570"></a>  <span class="fu">return</span>(best_fit)</span>
<span id="cb1-571"><a href="#cb1-571"></a>}</span>
<span id="cb1-572"><a href="#cb1-572"></a><span class="st">```</span></span>
<span id="cb1-573"><a href="#cb1-573"></a></span>
<span id="cb1-574"><a href="#cb1-574"></a><span class="at">OK, let's try this out. Say we don't converge with the first optimizer choice,</span></span>
<span id="cb1-575"><a href="#cb1-575"></a><span class="at">and then want to run multiple ones.</span></span>
<span id="cb1-576"><a href="#cb1-576"></a></span>
<span id="cb1-577"><a href="#cb1-577"></a><span class="st">```</span>{r}</span>
<span id="cb1-578"><a href="#cb1-578"></a>mod_fit <span class="ot">&lt;-</span> <span class="fu">fit_single_optimizer</span>(</span>
<span id="cb1-579"><a href="#cb1-579"></a>  <span class="at">formula =</span> <span class="fu">h_build_formula</span>(vs),</span>
<span id="cb1-580"><a href="#cb1-580"></a>  <span class="at">data =</span> dat,</span>
<span id="cb1-581"><a href="#cb1-581"></a>  <span class="at">optimizer =</span> <span class="st">"Nelder-Mead"</span></span>
<span id="cb1-582"><a href="#cb1-582"></a>)</span>
<span id="cb1-583"><a href="#cb1-583"></a><span class="fu">attr</span>(mod_fit, <span class="st">"converged"</span>)</span>
<span id="cb1-584"><a href="#cb1-584"></a><span class="fu">attr</span>(mod_fit, <span class="st">"warnings"</span>)</span>
<span id="cb1-585"><a href="#cb1-585"></a><span class="st">```</span></span>
<span id="cb1-586"><a href="#cb1-586"></a></span>
<span id="cb1-587"><a href="#cb1-587"></a><span class="at">So Nelder-Mead does not converge, and we see a non-positive-definite Hessian</span></span>
<span id="cb1-588"><a href="#cb1-588"></a><span class="at">warning.</span></span>
<span id="cb1-589"><a href="#cb1-589"></a><span class="at">Now we put this into the refit function:</span></span>
<span id="cb1-590"><a href="#cb1-590"></a></span>
<span id="cb1-591"><a href="#cb1-591"></a><span class="st">```</span>{r}</span>
<span id="cb1-592"><a href="#cb1-592"></a>mod_refit <span class="ot">&lt;-</span> <span class="fu">refit_multiple_optimizers</span>(mod_fit)</span>
<span id="cb1-593"><a href="#cb1-593"></a><span class="st">```</span></span>
<span id="cb1-594"><a href="#cb1-594"></a></span>
<span id="cb1-595"><a href="#cb1-595"></a><span class="at">## </span><span class="st">`</span><span class="fu">fit_model</span>()<span class="st">`</span></span>
<span id="cb1-596"><a href="#cb1-596"></a></span>
<span id="cb1-597"><a href="#cb1-597"></a><span class="at">This is wrapping the lower level fitting functions (single and multiple optimizers).</span></span>
<span id="cb1-598"><a href="#cb1-598"></a></span>
<span id="cb1-599"><a href="#cb1-599"></a><span class="st">```</span>{r}</span>
<span id="cb1-600"><a href="#cb1-600"></a>fit_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula,</span>
<span id="cb1-601"><a href="#cb1-601"></a>                      data,</span>
<span id="cb1-602"><a href="#cb1-602"></a>                      <span class="at">optimizer =</span> <span class="st">"automatic"</span>,</span>
<span id="cb1-603"><a href="#cb1-603"></a>                      <span class="at">n_cores =</span> 1L) {</span>
<span id="cb1-604"><a href="#cb1-604"></a>  <span class="fu">assert_string</span>(optimizer)</span>
<span id="cb1-605"><a href="#cb1-605"></a>  use_automatic <span class="ot">&lt;-</span> <span class="fu">identical</span>(optimizer, <span class="st">"automatic"</span>)</span>
<span id="cb1-606"><a href="#cb1-606"></a></span>
<span id="cb1-607"><a href="#cb1-607"></a>  fit <span class="ot">&lt;-</span> <span class="fu">fit_single_optimizer</span>(</span>
<span id="cb1-608"><a href="#cb1-608"></a>    <span class="at">formula =</span> formula,</span>
<span id="cb1-609"><a href="#cb1-609"></a>    <span class="at">data =</span> data,</span>
<span id="cb1-610"><a href="#cb1-610"></a>    <span class="at">optimizer =</span> <span class="fu">ifelse</span>(use_automatic, <span class="st">"L-BFGS-B"</span>, optimizer)</span>
<span id="cb1-611"><a href="#cb1-611"></a>  )</span>
<span id="cb1-612"><a href="#cb1-612"></a></span>
<span id="cb1-613"><a href="#cb1-613"></a>  <span class="cf">if</span> (<span class="fu">attr</span>(fit, <span class="st">"converged"</span>)) {</span>
<span id="cb1-614"><a href="#cb1-614"></a>    fit</span>
<span id="cb1-615"><a href="#cb1-615"></a>  } <span class="cf">else</span> <span class="cf">if</span> (use_automatic) {</span>
<span id="cb1-616"><a href="#cb1-616"></a>    <span class="fu">refit_multiple_optimizers</span>(fit, <span class="at">n_cores =</span> n_cores)</span>
<span id="cb1-617"><a href="#cb1-617"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-618"><a href="#cb1-618"></a>    all_problems <span class="ot">&lt;-</span> <span class="fu">unlist</span>(</span>
<span id="cb1-619"><a href="#cb1-619"></a>      <span class="fu">attributes</span>(fit)[<span class="fu">c</span>(<span class="st">"errors"</span>, <span class="st">"messages"</span>, <span class="st">"warnings"</span>)],</span>
<span id="cb1-620"><a href="#cb1-620"></a>      <span class="at">use.names =</span> <span class="cn">FALSE</span></span>
<span id="cb1-621"><a href="#cb1-621"></a>    )</span>
<span id="cb1-622"><a href="#cb1-622"></a>    <span class="fu">stop</span>(<span class="fu">paste0</span>(</span>
<span id="cb1-623"><a href="#cb1-623"></a>      <span class="st">"Chosen optimizer '"</span>, optimizer, <span class="st">"' led to problems during model fit:</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb1-624"><a href="#cb1-624"></a>      <span class="fu">paste</span>(<span class="fu">paste0</span>(<span class="fu">seq_along</span>(all_problems), <span class="st">") "</span>, all_problems), <span class="at">collapse =</span> <span class="st">";</span><span class="sc">\n</span><span class="st">"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb1-625"><a href="#cb1-625"></a>      <span class="st">"Consider using the 'automatic' optimizer."</span></span>
<span id="cb1-626"><a href="#cb1-626"></a>    ))</span>
<span id="cb1-627"><a href="#cb1-627"></a>  }</span>
<span id="cb1-628"><a href="#cb1-628"></a>}</span>
<span id="cb1-629"><a href="#cb1-629"></a><span class="st">```</span></span>
<span id="cb1-630"><a href="#cb1-630"></a></span>
<span id="cb1-631"><a href="#cb1-631"></a><span class="at">Let's try this out quickly too:</span></span>
<span id="cb1-632"><a href="#cb1-632"></a></span>
<span id="cb1-633"><a href="#cb1-633"></a><span class="st">```</span>{r}</span>
<span id="cb1-634"><a href="#cb1-634"></a>testthat<span class="sc">::</span><span class="fu">expect_error</span>(<span class="fu">fit_model</span>(</span>
<span id="cb1-635"><a href="#cb1-635"></a>  <span class="at">formula =</span> <span class="fu">h_build_formula</span>(vs),</span>
<span id="cb1-636"><a href="#cb1-636"></a>  <span class="at">data =</span> dat,</span>
<span id="cb1-637"><a href="#cb1-637"></a>  <span class="at">optimizer =</span> <span class="st">"Nelder-Mead"</span></span>
<span id="cb1-638"><a href="#cb1-638"></a>))</span>
<span id="cb1-639"><a href="#cb1-639"></a><span class="st">```</span></span>
<span id="cb1-640"><a href="#cb1-640"></a></span>
<span id="cb1-641"><a href="#cb1-641"></a><span class="at">So this gives the expected error message.</span></span>
<span id="cb1-642"><a href="#cb1-642"></a></span>
<span id="cb1-643"><a href="#cb1-643"></a><span class="st">```</span>{r}</span>
<span id="cb1-644"><a href="#cb1-644"></a>mod_fit2 <span class="ot">&lt;-</span> <span class="fu">fit_model</span>(</span>
<span id="cb1-645"><a href="#cb1-645"></a>  <span class="at">formula =</span> <span class="fu">h_build_formula</span>(vs),</span>
<span id="cb1-646"><a href="#cb1-646"></a>  <span class="at">data =</span> dat,</span>
<span id="cb1-647"><a href="#cb1-647"></a>  <span class="at">optimizer =</span> <span class="st">"BFGS"</span></span>
<span id="cb1-648"><a href="#cb1-648"></a>)</span>
<span id="cb1-649"><a href="#cb1-649"></a><span class="st">```</span></span>
<span id="cb1-650"><a href="#cb1-650"></a></span>
<span id="cb1-651"><a href="#cb1-651"></a><span class="at">And this works.</span></span>
<span id="cb1-652"><a href="#cb1-652"></a></span>
<span id="cb1-653"><a href="#cb1-653"></a><span class="at">## </span><span class="st">`</span><span class="fu">vars</span>()<span class="st">`</span></span>
<span id="cb1-654"><a href="#cb1-654"></a></span>
<span id="cb1-655"><a href="#cb1-655"></a><span class="at">Just a little user interface list generator for the variables to use in </span><span class="st">`</span><span class="fu">mmrm</span>()<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-656"><a href="#cb1-656"></a></span>
<span id="cb1-657"><a href="#cb1-657"></a><span class="st">```</span>{r}</span>
<span id="cb1-658"><a href="#cb1-658"></a>vars <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">response =</span> <span class="st">"AVAL"</span>,</span>
<span id="cb1-659"><a href="#cb1-659"></a>                 <span class="at">covariates =</span> <span class="fu">c</span>(),</span>
<span id="cb1-660"><a href="#cb1-660"></a>                 <span class="at">id =</span> <span class="st">"USUBJID"</span>,</span>
<span id="cb1-661"><a href="#cb1-661"></a>                 <span class="at">arm =</span> <span class="st">"ARM"</span>,</span>
<span id="cb1-662"><a href="#cb1-662"></a>                 <span class="at">visit =</span> <span class="st">"AVISIT"</span>) {</span>
<span id="cb1-663"><a href="#cb1-663"></a>  <span class="fu">list</span>(</span>
<span id="cb1-664"><a href="#cb1-664"></a>    <span class="at">response =</span> response,</span>
<span id="cb1-665"><a href="#cb1-665"></a>    <span class="at">covariates =</span> covariates,</span>
<span id="cb1-666"><a href="#cb1-666"></a>    <span class="at">id =</span> id,</span>
<span id="cb1-667"><a href="#cb1-667"></a>    <span class="at">arm =</span> arm,</span>
<span id="cb1-668"><a href="#cb1-668"></a>    <span class="at">visit =</span> visit</span>
<span id="cb1-669"><a href="#cb1-669"></a>  )</span>
<span id="cb1-670"><a href="#cb1-670"></a>}</span>
<span id="cb1-671"><a href="#cb1-671"></a></span>
<span id="cb1-672"><a href="#cb1-672"></a><span class="fu">vars</span>()</span>
<span id="cb1-673"><a href="#cb1-673"></a><span class="st">```</span></span>
<span id="cb1-674"><a href="#cb1-674"></a></span>
<span id="cb1-675"><a href="#cb1-675"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_vcov_theta</span>()<span class="st">`</span></span>
<span id="cb1-676"><a href="#cb1-676"></a></span>
<span id="cb1-677"><a href="#cb1-677"></a><span class="at">This helper function returns the covariance estimate for the variance parameters</span></span>
<span id="cb1-678"><a href="#cb1-678"></a><span class="at">(</span><span class="st">`</span>theta<span class="st">`</span><span class="at">) of the fitted MMRM.</span></span>
<span id="cb1-679"><a href="#cb1-679"></a></span>
<span id="cb1-680"><a href="#cb1-680"></a><span class="st">```</span>{r}</span>
<span id="cb1-681"><a href="#cb1-681"></a>h_vcov_theta <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb1-682"><a href="#cb1-682"></a>  <span class="fu">assert_class</span>(model, <span class="st">"mmrm_fit"</span>)</span>
<span id="cb1-683"><a href="#cb1-683"></a></span>
<span id="cb1-684"><a href="#cb1-684"></a>  model_vcov <span class="ot">&lt;-</span> <span class="fu">vcov</span>(model, <span class="at">full =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-685"><a href="#cb1-685"></a>  theta <span class="ot">&lt;-</span> <span class="fu">getME</span>(model, <span class="st">"theta"</span>)</span>
<span id="cb1-686"><a href="#cb1-686"></a>  index_theta <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">to =</span> <span class="fu">nrow</span>(model_vcov), <span class="at">length =</span> <span class="fu">length</span>(theta))</span>
<span id="cb1-687"><a href="#cb1-687"></a></span>
<span id="cb1-688"><a href="#cb1-688"></a>  <span class="fu">unname</span>(model_vcov[index_theta, index_theta, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb1-689"><a href="#cb1-689"></a>}</span>
<span id="cb1-690"><a href="#cb1-690"></a></span>
<span id="cb1-691"><a href="#cb1-691"></a>vcov_theta <span class="ot">&lt;-</span> <span class="fu">h_vcov_theta</span>(mod_refit)</span>
<span id="cb1-692"><a href="#cb1-692"></a><span class="st">```</span></span>
<span id="cb1-693"><a href="#cb1-693"></a></span>
<span id="cb1-694"><a href="#cb1-694"></a><span class="at">However one question is now which </span><span class="st">`</span>theta<span class="st">`</span><span class="at"> parametrization is used here</span></span>
<span id="cb1-695"><a href="#cb1-695"></a><span class="at">to provide the covariance matrix of. Because it is strange that these two</span></span>
<span id="cb1-696"><a href="#cb1-696"></a><span class="at">are not the same:</span></span>
<span id="cb1-697"><a href="#cb1-697"></a></span>
<span id="cb1-698"><a href="#cb1-698"></a><span class="st">```</span>{r}</span>
<span id="cb1-699"><a href="#cb1-699"></a>mod_refit<span class="sc">$</span>obj<span class="sc">$</span>par</span>
<span id="cb1-700"><a href="#cb1-700"></a>mod_refit<span class="sc">$</span>fit<span class="sc">$</span>par</span>
<span id="cb1-701"><a href="#cb1-701"></a><span class="st">```</span></span>
<span id="cb1-702"><a href="#cb1-702"></a></span>
<span id="cb1-703"><a href="#cb1-703"></a><span class="at">It could be that the first one are the starting values for the optimization.</span></span>
<span id="cb1-704"><a href="#cb1-704"></a><span class="at">Indeed:</span></span>
<span id="cb1-705"><a href="#cb1-705"></a></span>
<span id="cb1-706"><a href="#cb1-706"></a><span class="st">```</span>{r}</span>
<span id="cb1-707"><a href="#cb1-707"></a><span class="fu">identical</span>(mod_fit<span class="sc">$</span>fit<span class="sc">$</span>par, mod_refit<span class="sc">$</span>obj<span class="sc">$</span>par)</span>
<span id="cb1-708"><a href="#cb1-708"></a><span class="st">```</span></span>
<span id="cb1-709"><a href="#cb1-709"></a></span>
<span id="cb1-710"><a href="#cb1-710"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_num_vcov_theta</span>()<span class="st">`</span></span>
<span id="cb1-711"><a href="#cb1-711"></a></span>
<span id="cb1-712"><a href="#cb1-712"></a><span class="at">Let's see anyway if we can recover this covariance matrix also numerically:</span></span>
<span id="cb1-713"><a href="#cb1-713"></a></span>
<span id="cb1-714"><a href="#cb1-714"></a><span class="st">```</span>{r}</span>
<span id="cb1-715"><a href="#cb1-715"></a>h_num_vcov_theta <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb1-716"><a href="#cb1-716"></a>  <span class="fu">assert_class</span>(model, <span class="st">"mmrm_fit"</span>)</span>
<span id="cb1-717"><a href="#cb1-717"></a></span>
<span id="cb1-718"><a href="#cb1-718"></a>  theta_est <span class="ot">&lt;-</span> model<span class="sc">$</span>fit<span class="sc">$</span>par</span>
<span id="cb1-719"><a href="#cb1-719"></a>  devfun_theta <span class="ot">&lt;-</span> model<span class="sc">$</span>obj<span class="sc">$</span>fn</span>
<span id="cb1-720"><a href="#cb1-720"></a>  hess_theta <span class="ot">&lt;-</span> numDeriv<span class="sc">::</span><span class="fu">hessian</span>(<span class="at">func =</span> devfun_theta, <span class="at">x =</span> theta_est)</span>
<span id="cb1-721"><a href="#cb1-721"></a>  eig_hess_theta <span class="ot">&lt;-</span> <span class="fu">eigen</span>(hess_theta, <span class="at">symmetric =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-722"><a href="#cb1-722"></a>  <span class="fu">with</span>(eig_hess_theta, vectors <span class="sc">%*%</span> <span class="fu">diag</span>(<span class="dv">1</span> <span class="sc">/</span> values) <span class="sc">%*%</span> <span class="fu">t</span>(vectors))</span>
<span id="cb1-723"><a href="#cb1-723"></a>}</span>
<span id="cb1-724"><a href="#cb1-724"></a></span>
<span id="cb1-725"><a href="#cb1-725"></a>num_vcov_theta <span class="ot">&lt;-</span> <span class="fu">h_num_vcov_theta</span>(mod_refit)</span>
<span id="cb1-726"><a href="#cb1-726"></a><span class="fu">all.equal</span>(vcov_theta, num_vcov_theta)</span>
<span id="cb1-727"><a href="#cb1-727"></a><span class="fu">range</span>(vcov_theta <span class="sc">/</span> num_vcov_theta)</span>
<span id="cb1-728"><a href="#cb1-728"></a><span class="st">```</span></span>
<span id="cb1-729"><a href="#cb1-729"></a></span>
<span id="cb1-730"><a href="#cb1-730"></a><span class="at">So the results are quite different.</span></span>
<span id="cb1-731"><a href="#cb1-731"></a></span>
<span id="cb1-732"><a href="#cb1-732"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_covbeta_fun</span>()<span class="st">`</span></span>
<span id="cb1-733"><a href="#cb1-733"></a></span>
<span id="cb1-734"><a href="#cb1-734"></a><span class="at">For below we need to construct a function </span><span class="st">`</span>covbeta_fun<span class="st">`</span><span class="at"> calculating</span></span>
<span id="cb1-735"><a href="#cb1-735"></a><span class="at">the covariance matrix for the fixed effects (</span><span class="st">`</span>beta<span class="st">`</span><span class="at">) as a function of the</span></span>
<span id="cb1-736"><a href="#cb1-736"></a><span class="at">variance parameters.</span></span>
<span id="cb1-737"><a href="#cb1-737"></a></span>
<span id="cb1-738"><a href="#cb1-738"></a><span class="st">```</span>{r}</span>
<span id="cb1-739"><a href="#cb1-739"></a>h_covbeta_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb1-740"><a href="#cb1-740"></a>  <span class="fu">assert_class</span>(model, <span class="st">"mmrm_fit"</span>)</span>
<span id="cb1-741"><a href="#cb1-741"></a></span>
<span id="cb1-742"><a href="#cb1-742"></a>  <span class="cf">function</span>(theta) {</span>
<span id="cb1-743"><a href="#cb1-743"></a>    sdr <span class="ot">&lt;-</span> TMB<span class="sc">::</span><span class="fu">sdreport</span>(</span>
<span id="cb1-744"><a href="#cb1-744"></a>      model<span class="sc">$</span>obj,</span>
<span id="cb1-745"><a href="#cb1-745"></a>      <span class="at">par.fixed =</span> theta,</span>
<span id="cb1-746"><a href="#cb1-746"></a>      <span class="at">getJointPrecision =</span> <span class="cn">TRUE</span></span>
<span id="cb1-747"><a href="#cb1-747"></a>    )</span>
<span id="cb1-748"><a href="#cb1-748"></a>    q_mat <span class="ot">&lt;-</span> sdr<span class="sc">$</span>jointPrecision</span>
<span id="cb1-749"><a href="#cb1-749"></a>    which_fixed <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">rownames</span>(q_mat) <span class="sc">==</span> <span class="st">"beta"</span>)</span>
<span id="cb1-750"><a href="#cb1-750"></a>    q_marginal <span class="ot">&lt;-</span> glmmTMB<span class="sc">:::</span><span class="fu">GMRFmarginal</span>(q_mat, which_fixed)</span>
<span id="cb1-751"><a href="#cb1-751"></a>    <span class="fu">unname</span>(<span class="fu">solve</span>(<span class="fu">as.matrix</span>(q_marginal)))</span>
<span id="cb1-752"><a href="#cb1-752"></a>  }</span>
<span id="cb1-753"><a href="#cb1-753"></a>}</span>
<span id="cb1-754"><a href="#cb1-754"></a><span class="st">```</span></span>
<span id="cb1-755"><a href="#cb1-755"></a></span>
<span id="cb1-756"><a href="#cb1-756"></a><span class="at">Let's try this out: We can recover the usual variance-covariance matrix of the</span></span>
<span id="cb1-757"><a href="#cb1-757"></a><span class="at">fixed effects when plugging in the estimated variance parameters (up to</span></span>
<span id="cb1-758"><a href="#cb1-758"></a><span class="at">reasonable numeric precision), and we get a different result when using</span></span>
<span id="cb1-759"><a href="#cb1-759"></a><span class="at">other variance parameters.</span></span>
<span id="cb1-760"><a href="#cb1-760"></a></span>
<span id="cb1-761"><a href="#cb1-761"></a><span class="st">```</span>{r}</span>
<span id="cb1-762"><a href="#cb1-762"></a>covbeta_fun <span class="ot">&lt;-</span> <span class="fu">h_covbeta_fun</span>(mod_refit)</span>
<span id="cb1-763"><a href="#cb1-763"></a>mod_theta_est <span class="ot">&lt;-</span> <span class="fu">getME</span>(mod_refit, <span class="st">"theta"</span>)</span>
<span id="cb1-764"><a href="#cb1-764"></a>covbeta_num <span class="ot">&lt;-</span> <span class="fu">covbeta_fun</span>(<span class="at">theta =</span> mod_theta_est)</span>
<span id="cb1-765"><a href="#cb1-765"></a>covbeta_fit <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">vcov</span>(mod_refit)<span class="sc">$</span>cond)</span>
<span id="cb1-766"><a href="#cb1-766"></a><span class="fu">all.equal</span>(covbeta_num, covbeta_fit)</span>
<span id="cb1-767"><a href="#cb1-767"></a><span class="fu">range</span>(covbeta_num <span class="sc">/</span> covbeta_fit)</span>
<span id="cb1-768"><a href="#cb1-768"></a><span class="fu">range</span>(covbeta_num <span class="sc">-</span> <span class="fu">covbeta_fun</span>(<span class="at">theta =</span> mod_theta_est <span class="sc">*</span> <span class="fl">0.9</span>))</span>
<span id="cb1-769"><a href="#cb1-769"></a><span class="st">```</span></span>
<span id="cb1-770"><a href="#cb1-770"></a></span>
<span id="cb1-771"><a href="#cb1-771"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_general_jac_list</span>()<span class="st">`</span></span>
<span id="cb1-772"><a href="#cb1-772"></a></span>
<span id="cb1-773"><a href="#cb1-773"></a><span class="at">We also need to compute the jacobian, and organize it as a list.</span></span>
<span id="cb1-774"><a href="#cb1-774"></a></span>
<span id="cb1-775"><a href="#cb1-775"></a><span class="at">We start with a general helper that takes a function </span><span class="st">`</span>covbeta_fun<span class="st">`</span><span class="at"> (see above),</span></span>
<span id="cb1-776"><a href="#cb1-776"></a><span class="at">as well as </span><span class="st">`</span>x_opt<span class="st">`</span><span class="at"> which is the variance parameter estimate.</span></span>
<span id="cb1-777"><a href="#cb1-777"></a></span>
<span id="cb1-778"><a href="#cb1-778"></a><span class="st">```</span>{r}</span>
<span id="cb1-779"><a href="#cb1-779"></a>h_general_jac_list <span class="ot">&lt;-</span> <span class="cf">function</span>(covbeta_fun,</span>
<span id="cb1-780"><a href="#cb1-780"></a>                               x_opt,</span>
<span id="cb1-781"><a href="#cb1-781"></a>                               ...) {</span>
<span id="cb1-782"><a href="#cb1-782"></a>  <span class="fu">assert_function</span>(covbeta_fun, <span class="at">nargs =</span> 1L)</span>
<span id="cb1-783"><a href="#cb1-783"></a>  <span class="fu">assert_numeric</span>(x_opt, <span class="at">any.missing =</span> <span class="cn">FALSE</span>, <span class="at">min.len =</span> 1L)</span>
<span id="cb1-784"><a href="#cb1-784"></a></span>
<span id="cb1-785"><a href="#cb1-785"></a>  jac_matrix <span class="ot">&lt;-</span> numDeriv<span class="sc">::</span><span class="fu">jacobian</span>(</span>
<span id="cb1-786"><a href="#cb1-786"></a>    <span class="at">func =</span> covbeta_fun,</span>
<span id="cb1-787"><a href="#cb1-787"></a>    <span class="at">x =</span> x_opt,</span>
<span id="cb1-788"><a href="#cb1-788"></a>    <span class="co"># Note: No need to specify further `methods.args` here.</span></span>
<span id="cb1-789"><a href="#cb1-789"></a>    ...</span>
<span id="cb1-790"><a href="#cb1-790"></a>  )</span>
<span id="cb1-791"><a href="#cb1-791"></a>  get_column_i_as_matrix <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb1-792"><a href="#cb1-792"></a>    <span class="co"># This column contains the p x p entries.</span></span>
<span id="cb1-793"><a href="#cb1-793"></a>    jac_col <span class="ot">&lt;-</span> jac_matrix[, i]</span>
<span id="cb1-794"><a href="#cb1-794"></a>    p <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(jac_col))</span>
<span id="cb1-795"><a href="#cb1-795"></a>    <span class="co"># Obtain p x p matrix.</span></span>
<span id="cb1-796"><a href="#cb1-796"></a>    <span class="fu">matrix</span>(jac_col, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb1-797"><a href="#cb1-797"></a>  }</span>
<span id="cb1-798"><a href="#cb1-798"></a>  <span class="fu">lapply</span>(</span>
<span id="cb1-799"><a href="#cb1-799"></a>    <span class="fu">seq_len</span>(<span class="fu">ncol</span>(jac_matrix)),</span>
<span id="cb1-800"><a href="#cb1-800"></a>    <span class="at">FUN =</span> get_column_i_as_matrix</span>
<span id="cb1-801"><a href="#cb1-801"></a>  )</span>
<span id="cb1-802"><a href="#cb1-802"></a>}</span>
<span id="cb1-803"><a href="#cb1-803"></a><span class="st">```</span></span>
<span id="cb1-804"><a href="#cb1-804"></a></span>
<span id="cb1-805"><a href="#cb1-805"></a><span class="at">Let's try this out, too:</span></span>
<span id="cb1-806"><a href="#cb1-806"></a></span>
<span id="cb1-807"><a href="#cb1-807"></a><span class="st">```</span>{r}</span>
<span id="cb1-808"><a href="#cb1-808"></a>jac_example <span class="ot">&lt;-</span> <span class="fu">h_general_jac_list</span>(covbeta_fun, mod_theta_est)</span>
<span id="cb1-809"><a href="#cb1-809"></a><span class="st">```</span></span>
<span id="cb1-810"><a href="#cb1-810"></a></span>
<span id="cb1-811"><a href="#cb1-811"></a><span class="at">So this takes a few seconds to generate. However this is still in the same</span></span>
<span id="cb1-812"><a href="#cb1-812"></a><span class="at">ballpark as the fitting of the MMRM itself, so should not be practical problem.</span></span>
<span id="cb1-813"><a href="#cb1-813"></a></span>
<span id="cb1-814"><a href="#cb1-814"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_jac_list</span>()<span class="st">`</span></span>
<span id="cb1-815"><a href="#cb1-815"></a></span>
<span id="cb1-816"><a href="#cb1-816"></a><span class="at">Now we can wrap this in a function that takes the fitted MMRM directly and</span></span>
<span id="cb1-817"><a href="#cb1-817"></a><span class="at">returns the Jacobian.</span></span>
<span id="cb1-818"><a href="#cb1-818"></a></span>
<span id="cb1-819"><a href="#cb1-819"></a><span class="st">```</span>{r}</span>
<span id="cb1-820"><a href="#cb1-820"></a>h_jac_list <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb1-821"><a href="#cb1-821"></a>  covbeta_fun <span class="ot">&lt;-</span> <span class="fu">h_covbeta_fun</span>(model)</span>
<span id="cb1-822"><a href="#cb1-822"></a>  theta_est <span class="ot">&lt;-</span> <span class="fu">getME</span>(model, <span class="st">"theta"</span>)</span>
<span id="cb1-823"><a href="#cb1-823"></a>  <span class="fu">h_general_jac_list</span>(<span class="at">covbeta_fun =</span> covbeta_fun, <span class="at">x_opt =</span> theta_est)</span>
<span id="cb1-824"><a href="#cb1-824"></a>}</span>
<span id="cb1-825"><a href="#cb1-825"></a></span>
<span id="cb1-826"><a href="#cb1-826"></a>jac_list <span class="ot">&lt;-</span> <span class="fu">h_jac_list</span>(mod_refit)</span>
<span id="cb1-827"><a href="#cb1-827"></a><span class="st">```</span></span>
<span id="cb1-828"><a href="#cb1-828"></a></span>
<span id="cb1-829"><a href="#cb1-829"></a><span class="at">## </span><span class="st">`</span><span class="fu">mmrm</span>()<span class="st">`</span></span>
<span id="cb1-830"><a href="#cb1-830"></a></span>
<span id="cb1-831"><a href="#cb1-831"></a><span class="at">This is the primary user interface for performing the MMRM analysis. It returns</span></span>
<span id="cb1-832"><a href="#cb1-832"></a><span class="at">an object of class </span><span class="st">`</span>mmrm<span class="st">`</span><span class="at"> and further methods are provided then to work with</span></span>
<span id="cb1-833"><a href="#cb1-833"></a><span class="at">these objects (summary, least square means, etc.)</span></span>
<span id="cb1-834"><a href="#cb1-834"></a></span>
<span id="cb1-835"><a href="#cb1-835"></a><span class="at">Note that since the least square means and model diagnostics are downstream</span></span>
<span id="cb1-836"><a href="#cb1-836"></a><span class="at">calculations, we no longer include them in the object itself.</span></span>
<span id="cb1-837"><a href="#cb1-837"></a></span>
<span id="cb1-838"><a href="#cb1-838"></a><span class="st">```</span>{r}</span>
<span id="cb1-839"><a href="#cb1-839"></a>mmrm <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb1-840"><a href="#cb1-840"></a>                 <span class="at">vars =</span> <span class="fu">vars</span>(),</span>
<span id="cb1-841"><a href="#cb1-841"></a>                 <span class="at">conf_level =</span> <span class="fl">0.95</span>,</span>
<span id="cb1-842"><a href="#cb1-842"></a>                 <span class="at">cor_struct =</span> <span class="st">"unstructured"</span>,</span>
<span id="cb1-843"><a href="#cb1-843"></a>                 <span class="at">weights_emmeans =</span> <span class="st">"proportional"</span>,</span>
<span id="cb1-844"><a href="#cb1-844"></a>                 <span class="at">optimizer =</span> <span class="st">"automatic"</span>,</span>
<span id="cb1-845"><a href="#cb1-845"></a>                 <span class="at">parallel =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb1-846"><a href="#cb1-846"></a>  <span class="fu">assert_data</span>(vars, data)</span>
<span id="cb1-847"><a href="#cb1-847"></a>  <span class="fu">assert_number</span>(conf_level, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="dv">1</span>)</span>
<span id="cb1-848"><a href="#cb1-848"></a>  <span class="fu">assert_flag</span>(parallel)</span>
<span id="cb1-849"><a href="#cb1-849"></a></span>
<span id="cb1-850"><a href="#cb1-850"></a>  labels <span class="ot">&lt;-</span> <span class="fu">h_labels</span>(vars, data)</span>
<span id="cb1-851"><a href="#cb1-851"></a>  formula <span class="ot">&lt;-</span> <span class="fu">h_build_formula</span>(vars, cor_struct)</span>
<span id="cb1-852"><a href="#cb1-852"></a>  model <span class="ot">&lt;-</span> <span class="fu">fit_model</span>(</span>
<span id="cb1-853"><a href="#cb1-853"></a>    <span class="at">formula =</span> formula,</span>
<span id="cb1-854"><a href="#cb1-854"></a>    <span class="at">data =</span> data,</span>
<span id="cb1-855"><a href="#cb1-855"></a>    <span class="at">optimizer =</span> optimizer,</span>
<span id="cb1-856"><a href="#cb1-856"></a>    <span class="at">n_cores =</span> <span class="fu">ifelse</span>(parallel, <span class="fu">h_free_cores</span>(), 1L)</span>
<span id="cb1-857"><a href="#cb1-857"></a>  )</span>
<span id="cb1-858"><a href="#cb1-858"></a>  vcov_theta <span class="ot">&lt;-</span> <span class="fu">h_num_vcov_theta</span>(model)</span>
<span id="cb1-859"><a href="#cb1-859"></a>  jac_list <span class="ot">&lt;-</span> <span class="fu">h_jac_list</span>(model)</span>
<span id="cb1-860"><a href="#cb1-860"></a>  vcov_beta <span class="ot">&lt;-</span> <span class="fu">vcov</span>(model)<span class="sc">$</span>cond</span>
<span id="cb1-861"><a href="#cb1-861"></a>  beta_est <span class="ot">&lt;-</span> <span class="fu">fixef</span>(model)<span class="sc">$</span>cond</span>
<span id="cb1-862"><a href="#cb1-862"></a>  cov_est <span class="ot">&lt;-</span> <span class="fu">h_cov_estimate</span>(model)</span>
<span id="cb1-863"><a href="#cb1-863"></a>  ref_level <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(vars<span class="sc">$</span>arm)) <span class="cn">NULL</span> <span class="cf">else</span> <span class="fu">levels</span>(data[[vars<span class="sc">$</span>arm]])[<span class="dv">1</span>]</span>
<span id="cb1-864"><a href="#cb1-864"></a></span>
<span id="cb1-865"><a href="#cb1-865"></a>  results <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-866"><a href="#cb1-866"></a>    <span class="at">model =</span> model,</span>
<span id="cb1-867"><a href="#cb1-867"></a>    <span class="at">vcov_theta =</span> vcov_theta,</span>
<span id="cb1-868"><a href="#cb1-868"></a>    <span class="at">jac_list =</span> jac_list,</span>
<span id="cb1-869"><a href="#cb1-869"></a>    <span class="at">vcov_beta =</span> vcov_beta,</span>
<span id="cb1-870"><a href="#cb1-870"></a>    <span class="at">beta_est =</span> beta_est,</span>
<span id="cb1-871"><a href="#cb1-871"></a>    <span class="at">cov_est =</span> cov_est,</span>
<span id="cb1-872"><a href="#cb1-872"></a>    <span class="at">vars =</span> vars,</span>
<span id="cb1-873"><a href="#cb1-873"></a>    <span class="at">labels =</span> labels,</span>
<span id="cb1-874"><a href="#cb1-874"></a>    <span class="at">ref_level =</span> ref_level,</span>
<span id="cb1-875"><a href="#cb1-875"></a>    <span class="at">conf_level =</span> conf_level</span>
<span id="cb1-876"><a href="#cb1-876"></a>  )</span>
<span id="cb1-877"><a href="#cb1-877"></a>  <span class="fu">class</span>(results) <span class="ot">&lt;-</span> <span class="st">"mmrm"</span></span>
<span id="cb1-878"><a href="#cb1-878"></a>  results</span>
<span id="cb1-879"><a href="#cb1-879"></a>}</span>
<span id="cb1-880"><a href="#cb1-880"></a><span class="st">```</span></span>
<span id="cb1-881"><a href="#cb1-881"></a></span>
<span id="cb1-882"><a href="#cb1-882"></a><span class="at">Let's try this out:</span></span>
<span id="cb1-883"><a href="#cb1-883"></a></span>
<span id="cb1-884"><a href="#cb1-884"></a><span class="st">```</span>{r}</span>
<span id="cb1-885"><a href="#cb1-885"></a>result <span class="ot">&lt;-</span> <span class="fu">mmrm</span>(dat, vs)</span>
<span id="cb1-886"><a href="#cb1-886"></a><span class="st">```</span></span>
<span id="cb1-887"><a href="#cb1-887"></a></span>
<span id="cb1-888"><a href="#cb1-888"></a><span class="at">Takes about 13 seconds on my computer here, so that is alright.</span></span>
<span id="cb1-889"><a href="#cb1-889"></a></span>
<span id="cb1-890"><a href="#cb1-890"></a><span class="at">## </span><span class="st">`</span><span class="fu">diagnostics</span>()<span class="st">`</span></span>
<span id="cb1-891"><a href="#cb1-891"></a></span>
<span id="cb1-892"><a href="#cb1-892"></a><span class="at">Now we want to compute the model diagnostic statistics. Note that here</span></span>
<span id="cb1-893"><a href="#cb1-893"></a><span class="at">we start now from the full </span><span class="st">`</span>mmrm<span class="st">`</span><span class="at"> object which already has the covariance</span></span>
<span id="cb1-894"><a href="#cb1-894"></a><span class="at">estimate, so we don't need to compute this again.</span></span>
<span id="cb1-895"><a href="#cb1-895"></a></span>
<span id="cb1-896"><a href="#cb1-896"></a><span class="at">Note: In production this can be a generic function with a method for </span><span class="st">`</span>mmrm<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-897"><a href="#cb1-897"></a></span>
<span id="cb1-898"><a href="#cb1-898"></a><span class="st">```</span>{r}</span>
<span id="cb1-899"><a href="#cb1-899"></a>diagnostics <span class="ot">&lt;-</span> <span class="cf">function</span>(object) {</span>
<span id="cb1-900"><a href="#cb1-900"></a>  <span class="fu">assert_class</span>(object, <span class="st">"mmrm"</span>)</span>
<span id="cb1-901"><a href="#cb1-901"></a></span>
<span id="cb1-902"><a href="#cb1-902"></a>  n_obs <span class="ot">&lt;-</span> object<span class="sc">$</span>model<span class="sc">$</span>modelInfo<span class="sc">$</span>nobs</span>
<span id="cb1-903"><a href="#cb1-903"></a>  cov_est <span class="ot">&lt;-</span> object<span class="sc">$</span>cov_est</span>
<span id="cb1-904"><a href="#cb1-904"></a>  df <span class="ot">&lt;-</span> <span class="fu">attr</span>(cov_est, <span class="st">"n_parameters"</span>)</span>
<span id="cb1-905"><a href="#cb1-905"></a>  n_fixed <span class="ot">&lt;-</span> <span class="fu">ncol</span>(<span class="fu">getME</span>(object<span class="sc">$</span>model, <span class="st">"X"</span>))</span>
<span id="cb1-906"><a href="#cb1-906"></a>  m <span class="ot">&lt;-</span> <span class="fu">max</span>(df <span class="sc">+</span> <span class="dv">2</span>, n_obs <span class="sc">-</span> n_fixed)</span>
<span id="cb1-907"><a href="#cb1-907"></a>  log_lik <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(stats<span class="sc">::</span><span class="fu">logLik</span>(object<span class="sc">$</span>model))</span>
<span id="cb1-908"><a href="#cb1-908"></a>  n_subjects <span class="ot">&lt;-</span> <span class="fu">nlevels</span>(object<span class="sc">$</span>model<span class="sc">$</span>modelInfo<span class="sc">$</span>reTrms<span class="sc">$</span>cond<span class="sc">$</span>flist[[1L]])</span>
<span id="cb1-909"><a href="#cb1-909"></a></span>
<span id="cb1-910"><a href="#cb1-910"></a>  <span class="fu">list</span>(</span>
<span id="cb1-911"><a href="#cb1-911"></a>    <span class="st">"REML criterion"</span> <span class="ot">=</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> log_lik,</span>
<span id="cb1-912"><a href="#cb1-912"></a>    <span class="at">AIC =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> log_lik <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> df,</span>
<span id="cb1-913"><a href="#cb1-913"></a>    <span class="at">AICc =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> log_lik <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> df <span class="sc">*</span> (m <span class="sc">/</span> (m <span class="sc">-</span> df <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb1-914"><a href="#cb1-914"></a>    <span class="at">BIC =</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> log_lik <span class="sc">+</span> df <span class="sc">*</span> <span class="fu">log</span>(n_subjects)</span>
<span id="cb1-915"><a href="#cb1-915"></a>  )</span>
<span id="cb1-916"><a href="#cb1-916"></a>}</span>
<span id="cb1-917"><a href="#cb1-917"></a></span>
<span id="cb1-918"><a href="#cb1-918"></a><span class="fu">diagnostics</span>(result)</span>
<span id="cb1-919"><a href="#cb1-919"></a><span class="st">```</span></span>
<span id="cb1-920"><a href="#cb1-920"></a></span>
<span id="cb1-921"><a href="#cb1-921"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_quad_form_vec</span>()<span class="st">`</span></span>
<span id="cb1-922"><a href="#cb1-922"></a></span>
<span id="cb1-923"><a href="#cb1-923"></a><span class="at">Just a small numeric helper to compute a quadratic form of a vector</span></span>
<span id="cb1-924"><a href="#cb1-924"></a><span class="at">and a matrix.</span></span>
<span id="cb1-925"><a href="#cb1-925"></a></span>
<span id="cb1-926"><a href="#cb1-926"></a><span class="st">```</span>{r}</span>
<span id="cb1-927"><a href="#cb1-927"></a><span class="co"># Calculates x %*% mat %*% t(x) efficiently if x is a (row) vector.</span></span>
<span id="cb1-928"><a href="#cb1-928"></a>h_quad_form_vec <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mat) {</span>
<span id="cb1-929"><a href="#cb1-929"></a>  <span class="fu">assert_numeric</span>(x, <span class="at">any.missing =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-930"><a href="#cb1-930"></a>  <span class="fu">assert_matrix</span>(mat, <span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">any.missing =</span> <span class="cn">FALSE</span>, <span class="at">nrows =</span> <span class="fu">length</span>(x), <span class="at">ncols =</span> <span class="fu">length</span>(x))</span>
<span id="cb1-931"><a href="#cb1-931"></a>  <span class="fu">sum</span>(x <span class="sc">*</span> (mat <span class="sc">%*%</span> x))</span>
<span id="cb1-932"><a href="#cb1-932"></a>}</span>
<span id="cb1-933"><a href="#cb1-933"></a></span>
<span id="cb1-934"><a href="#cb1-934"></a><span class="fu">h_quad_form_vec</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb1-935"><a href="#cb1-935"></a><span class="st">```</span></span>
<span id="cb1-936"><a href="#cb1-936"></a></span>
<span id="cb1-937"><a href="#cb1-937"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_gradient</span>()<span class="st">`</span></span>
<span id="cb1-938"><a href="#cb1-938"></a></span>
<span id="cb1-939"><a href="#cb1-939"></a><span class="at">This is the helper to compute the gradient based on a jacobian (as a list, as above)</span></span>
<span id="cb1-940"><a href="#cb1-940"></a><span class="at">and a vector </span><span class="st">`</span>L<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-941"><a href="#cb1-941"></a></span>
<span id="cb1-942"><a href="#cb1-942"></a><span class="st">```</span>{r}</span>
<span id="cb1-943"><a href="#cb1-943"></a>h_gradient <span class="ot">&lt;-</span> <span class="cf">function</span>(jac_list, L) {</span>
<span id="cb1-944"><a href="#cb1-944"></a>  <span class="fu">assert_list</span>(jac_list)</span>
<span id="cb1-945"><a href="#cb1-945"></a>  <span class="fu">assert_numeric</span>(L)</span>
<span id="cb1-946"><a href="#cb1-946"></a></span>
<span id="cb1-947"><a href="#cb1-947"></a>  <span class="fu">vapply</span>(</span>
<span id="cb1-948"><a href="#cb1-948"></a>    jac_list,</span>
<span id="cb1-949"><a href="#cb1-949"></a>    h_quad_form_vec, <span class="co"># = {L' Jac L}_i</span></span>
<span id="cb1-950"><a href="#cb1-950"></a>    <span class="at">x =</span> L,</span>
<span id="cb1-951"><a href="#cb1-951"></a>    <span class="fu">numeric</span>(1L)</span>
<span id="cb1-952"><a href="#cb1-952"></a>  )</span>
<span id="cb1-953"><a href="#cb1-953"></a>}</span>
<span id="cb1-954"><a href="#cb1-954"></a></span>
<span id="cb1-955"><a href="#cb1-955"></a>L <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb1-956"><a href="#cb1-956"></a><span class="fu">h_gradient</span>(jac_example, L)</span>
<span id="cb1-957"><a href="#cb1-957"></a><span class="st">```</span></span>
<span id="cb1-958"><a href="#cb1-958"></a></span>
<span id="cb1-959"><a href="#cb1-959"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_df_1d_list</span>()<span class="st">`</span></span>
<span id="cb1-960"><a href="#cb1-960"></a></span>
<span id="cb1-961"><a href="#cb1-961"></a><span class="at">Little helper function to format results of </span><span class="st">`</span><span class="fu">df_1d</span>()<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-962"><a href="#cb1-962"></a></span>
<span id="cb1-963"><a href="#cb1-963"></a><span class="st">```</span>{r}</span>
<span id="cb1-964"><a href="#cb1-964"></a>h_df_1d_list <span class="ot">&lt;-</span> <span class="cf">function</span>(est, se, v_num, v_denom) {</span>
<span id="cb1-965"><a href="#cb1-965"></a>  t_stat <span class="ot">&lt;-</span> est <span class="sc">/</span> se</span>
<span id="cb1-966"><a href="#cb1-966"></a>  df <span class="ot">&lt;-</span> v_num <span class="sc">/</span> v_denom</span>
<span id="cb1-967"><a href="#cb1-967"></a>  pval <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="at">q =</span> <span class="fu">abs</span>(t_stat), <span class="at">df =</span> df, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-968"><a href="#cb1-968"></a></span>
<span id="cb1-969"><a href="#cb1-969"></a>  <span class="fu">list</span>(</span>
<span id="cb1-970"><a href="#cb1-970"></a>    <span class="at">est =</span> est,</span>
<span id="cb1-971"><a href="#cb1-971"></a>    <span class="at">se =</span> se,</span>
<span id="cb1-972"><a href="#cb1-972"></a>    <span class="at">df =</span> df,</span>
<span id="cb1-973"><a href="#cb1-973"></a>    <span class="at">t_stat =</span> t_stat,</span>
<span id="cb1-974"><a href="#cb1-974"></a>    <span class="at">pval =</span> pval</span>
<span id="cb1-975"><a href="#cb1-975"></a>  )</span>
<span id="cb1-976"><a href="#cb1-976"></a>}</span>
<span id="cb1-977"><a href="#cb1-977"></a><span class="st">```</span></span>
<span id="cb1-978"><a href="#cb1-978"></a></span>
<span id="cb1-979"><a href="#cb1-979"></a><span class="at">## </span><span class="st">`</span><span class="fu">df_1d</span>()<span class="st">`</span></span>
<span id="cb1-980"><a href="#cb1-980"></a></span>
<span id="cb1-981"><a href="#cb1-981"></a><span class="at">We define this function to calculate the Satterthwaite degrees of freedom for the</span></span>
<span id="cb1-982"><a href="#cb1-982"></a><span class="at">one-dimensional case. It takes the </span><span class="st">`</span>mmrm<span class="st">`</span><span class="at"> object and the contrast matrix (here</span></span>
<span id="cb1-983"><a href="#cb1-983"></a><span class="at">vector).</span></span>
<span id="cb1-984"><a href="#cb1-984"></a></span>
<span id="cb1-985"><a href="#cb1-985"></a><span class="st">```</span>{r}</span>
<span id="cb1-986"><a href="#cb1-986"></a>df_1d <span class="ot">&lt;-</span> <span class="cf">function</span>(object, L) {</span>
<span id="cb1-987"><a href="#cb1-987"></a>  <span class="fu">assert_class</span>(object, <span class="st">"mmrm"</span>)</span>
<span id="cb1-988"><a href="#cb1-988"></a>  <span class="fu">assert_numeric</span>(L, <span class="at">any.missing =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-989"><a href="#cb1-989"></a></span>
<span id="cb1-990"><a href="#cb1-990"></a>  L <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(L)</span>
<span id="cb1-991"><a href="#cb1-991"></a>  <span class="fu">assert_numeric</span>(L, <span class="at">len =</span> <span class="fu">length</span>(object<span class="sc">$</span>beta_est))</span>
<span id="cb1-992"><a href="#cb1-992"></a>  contrast_est <span class="ot">&lt;-</span> <span class="fu">sum</span>(L <span class="sc">*</span> object<span class="sc">$</span>beta_est)</span>
<span id="cb1-993"><a href="#cb1-993"></a>  contrast_var <span class="ot">&lt;-</span> <span class="fu">h_quad_form_vec</span>(L, object<span class="sc">$</span>vcov_beta)</span>
<span id="cb1-994"><a href="#cb1-994"></a>  contrast_grad <span class="ot">&lt;-</span> <span class="fu">h_gradient</span>(object<span class="sc">$</span>jac_list, L)</span>
<span id="cb1-995"><a href="#cb1-995"></a></span>
<span id="cb1-996"><a href="#cb1-996"></a>  v_numerator <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> contrast_var<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-997"><a href="#cb1-997"></a>  v_denominator <span class="ot">&lt;-</span> <span class="fu">h_quad_form_vec</span>(contrast_grad, object<span class="sc">$</span>vcov_theta)</span>
<span id="cb1-998"><a href="#cb1-998"></a></span>
<span id="cb1-999"><a href="#cb1-999"></a>  <span class="fu">h_df_1d_list</span>(</span>
<span id="cb1-1000"><a href="#cb1-1000"></a>    <span class="at">est =</span> contrast_est,</span>
<span id="cb1-1001"><a href="#cb1-1001"></a>    <span class="at">se =</span> <span class="fu">sqrt</span>(contrast_var),</span>
<span id="cb1-1002"><a href="#cb1-1002"></a>    <span class="at">v_num =</span> v_numerator,</span>
<span id="cb1-1003"><a href="#cb1-1003"></a>    <span class="at">v_denom =</span> v_denominator</span>
<span id="cb1-1004"><a href="#cb1-1004"></a>  )</span>
<span id="cb1-1005"><a href="#cb1-1005"></a>}</span>
<span id="cb1-1006"><a href="#cb1-1006"></a><span class="st">```</span></span>
<span id="cb1-1007"><a href="#cb1-1007"></a></span>
<span id="cb1-1008"><a href="#cb1-1008"></a><span class="at">Let's try it out:</span></span>
<span id="cb1-1009"><a href="#cb1-1009"></a></span>
<span id="cb1-1010"><a href="#cb1-1010"></a><span class="st">```</span>{r}</span>
<span id="cb1-1011"><a href="#cb1-1011"></a><span class="fu">df_1d</span>(result, L)</span>
<span id="cb1-1012"><a href="#cb1-1012"></a><span class="st">```</span></span>
<span id="cb1-1013"><a href="#cb1-1013"></a></span>
<span id="cb1-1014"><a href="#cb1-1014"></a><span class="at">Let's quickly compare this with the existing </span><span class="st">`</span>tern.mmrm<span class="st">`</span><span class="at"> just to be sure</span></span>
<span id="cb1-1015"><a href="#cb1-1015"></a><span class="at">that this is correct:</span></span>
<span id="cb1-1016"><a href="#cb1-1016"></a></span>
<span id="cb1-1017"><a href="#cb1-1017"></a><span class="st">```</span>{r}</span>
<span id="cb1-1018"><a href="#cb1-1018"></a>old_result <span class="ot">&lt;-</span> tern.mmrm<span class="sc">::</span><span class="fu">fit_mmrm</span>(<span class="at">vars =</span> vs, <span class="at">data =</span> dat)</span>
<span id="cb1-1019"><a href="#cb1-1019"></a><span class="fu">all.equal</span>(result<span class="sc">$</span>beta_est, <span class="fu">fixef</span>(old_result<span class="sc">$</span>fit))</span>
<span id="cb1-1020"><a href="#cb1-1020"></a>lmerTest<span class="sc">::</span><span class="fu">contest1D</span>(old_result<span class="sc">$</span>fit, L)</span>
<span id="cb1-1021"><a href="#cb1-1021"></a><span class="st">```</span></span>
<span id="cb1-1022"><a href="#cb1-1022"></a></span>
<span id="cb1-1023"><a href="#cb1-1023"></a><span class="at">So unfortunately that the degrees of freedom results are very far apart.</span></span>
<span id="cb1-1024"><a href="#cb1-1024"></a><span class="at">The question is why?</span></span>
<span id="cb1-1025"><a href="#cb1-1025"></a></span>
<span id="cb1-1026"><a href="#cb1-1026"></a><span class="at">Let's look inside:</span></span>
<span id="cb1-1027"><a href="#cb1-1027"></a></span>
<span id="cb1-1028"><a href="#cb1-1028"></a><span class="st">```</span>{r}</span>
<span id="cb1-1029"><a href="#cb1-1029"></a><span class="co"># debug(lmerTest:::contest1D.lmerModLmerTest)</span></span>
<span id="cb1-1030"><a href="#cb1-1030"></a>lmerTest<span class="sc">::</span><span class="fu">contest1D</span>(old_result<span class="sc">$</span>fit, L)</span>
<span id="cb1-1031"><a href="#cb1-1031"></a><span class="st">```</span></span>
<span id="cb1-1032"><a href="#cb1-1032"></a></span>
<span id="cb1-1033"><a href="#cb1-1033"></a><span class="at">The denominator of the degrees of freedom is 0.0213 so completely different</span></span>
<span id="cb1-1034"><a href="#cb1-1034"></a><span class="at">than what we have above with 11.93. The numerator of the degrees of freedom</span></span>
<span id="cb1-1035"><a href="#cb1-1035"></a><span class="at">is 5.303 which is similar what we have with 5.425.</span></span>
<span id="cb1-1036"><a href="#cb1-1036"></a></span>
<span id="cb1-1037"><a href="#cb1-1037"></a><span class="at">Now for the denominator the problem is again that the parametrization is</span></span>
<span id="cb1-1038"><a href="#cb1-1038"></a><span class="at">different between </span><span class="st">`</span>lme4<span class="st">`</span><span class="at"> and </span><span class="st">`</span>glmmTMB<span class="st">`</span><span class="at"> so that we cannot compare directly</span></span>
<span id="cb1-1039"><a href="#cb1-1039"></a><span class="at">the inputs, i.e. the gradient for the variance of the contrast evaluated</span></span>
<span id="cb1-1040"><a href="#cb1-1040"></a><span class="at">at the variance parameter estimates, and the covariance matrix for variance</span></span>
<span id="cb1-1041"><a href="#cb1-1041"></a><span class="at">parameters.</span></span>
<span id="cb1-1042"><a href="#cb1-1042"></a></span>
<span id="cb1-1043"><a href="#cb1-1043"></a><span class="at">Let's quickly try another path to obtain the gradient numerically.</span></span>
<span id="cb1-1044"><a href="#cb1-1044"></a><span class="at">We write directly the contrast variance estimate as a function of </span><span class="st">`</span>theta<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-1045"><a href="#cb1-1045"></a></span>
<span id="cb1-1046"><a href="#cb1-1046"></a><span class="st">```</span>{r}</span>
<span id="cb1-1047"><a href="#cb1-1047"></a>h_contrast_var_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(model, L) {</span>
<span id="cb1-1048"><a href="#cb1-1048"></a>  covbeta_fun <span class="ot">&lt;-</span> <span class="fu">h_covbeta_fun</span>(model)</span>
<span id="cb1-1049"><a href="#cb1-1049"></a>  <span class="cf">function</span>(theta) {</span>
<span id="cb1-1050"><a href="#cb1-1050"></a>    covbeta <span class="ot">&lt;-</span> <span class="fu">covbeta_fun</span>(theta)</span>
<span id="cb1-1051"><a href="#cb1-1051"></a>    <span class="fu">h_quad_form_vec</span>(L, covbeta)</span>
<span id="cb1-1052"><a href="#cb1-1052"></a>  }</span>
<span id="cb1-1053"><a href="#cb1-1053"></a>}</span>
<span id="cb1-1054"><a href="#cb1-1054"></a></span>
<span id="cb1-1055"><a href="#cb1-1055"></a>contrast_var_fun <span class="ot">&lt;-</span> <span class="fu">h_contrast_var_fun</span>(result<span class="sc">$</span>model, L)</span>
<span id="cb1-1056"><a href="#cb1-1056"></a><span class="fu">sqrt</span>(<span class="fu">contrast_var_fun</span>(mod_theta_est))</span>
<span id="cb1-1057"><a href="#cb1-1057"></a><span class="st">```</span></span>
<span id="cb1-1058"><a href="#cb1-1058"></a></span>
<span id="cb1-1059"><a href="#cb1-1059"></a><span class="at">OK, this matches what we have above.</span></span>
<span id="cb1-1060"><a href="#cb1-1060"></a><span class="at">Now we can calculate the gradient again using </span><span class="st">`</span>numDeriv<span class="st">`</span><span class="at">:</span></span>
<span id="cb1-1061"><a href="#cb1-1061"></a></span>
<span id="cb1-1062"><a href="#cb1-1062"></a><span class="st">```</span>{r}</span>
<span id="cb1-1063"><a href="#cb1-1063"></a>num_grad_contrast_var <span class="ot">&lt;-</span> numDeriv<span class="sc">::</span><span class="fu">grad</span>(contrast_var_fun, mod_theta_est)</span>
<span id="cb1-1064"><a href="#cb1-1064"></a><span class="st">```</span></span>
<span id="cb1-1065"><a href="#cb1-1065"></a></span>
<span id="cb1-1066"><a href="#cb1-1066"></a><span class="at">It is interesting that this takes quite a while to compute.</span></span>
<span id="cb1-1067"><a href="#cb1-1067"></a></span>
<span id="cb1-1068"><a href="#cb1-1068"></a><span class="at">Now we can compare this with what we have via the Jacobian:</span></span>
<span id="cb1-1069"><a href="#cb1-1069"></a></span>
<span id="cb1-1070"><a href="#cb1-1070"></a><span class="st">```</span>{r}</span>
<span id="cb1-1071"><a href="#cb1-1071"></a>contrast_grad <span class="ot">&lt;-</span> <span class="fu">h_gradient</span>(result<span class="sc">$</span>jac_list, L)</span>
<span id="cb1-1072"><a href="#cb1-1072"></a><span class="fu">all.equal</span>(num_grad_contrast_var, contrast_grad)</span>
<span id="cb1-1073"><a href="#cb1-1073"></a>num_grad_contrast_var <span class="sc">-</span> contrast_grad</span>
<span id="cb1-1074"><a href="#cb1-1074"></a><span class="st">```</span></span>
<span id="cb1-1075"><a href="#cb1-1075"></a></span>
<span id="cb1-1076"><a href="#cb1-1076"></a><span class="at">So this is actually quite different. But even then we would get as</span></span>
<span id="cb1-1077"><a href="#cb1-1077"></a><span class="at">denominator:</span></span>
<span id="cb1-1078"><a href="#cb1-1078"></a></span>
<span id="cb1-1079"><a href="#cb1-1079"></a><span class="st">```</span>{r}</span>
<span id="cb1-1080"><a href="#cb1-1080"></a>num_v_denom <span class="ot">&lt;-</span> <span class="fu">h_quad_form_vec</span>(num_grad_contrast_var, result<span class="sc">$</span>vcov_theta)</span>
<span id="cb1-1081"><a href="#cb1-1081"></a>num_v_denom</span>
<span id="cb1-1082"><a href="#cb1-1082"></a><span class="st">```</span></span>
<span id="cb1-1083"><a href="#cb1-1083"></a></span>
<span id="cb1-1084"><a href="#cb1-1084"></a><span class="at">which is not what we expect. But on the other hand</span></span>
<span id="cb1-1085"><a href="#cb1-1085"></a></span>
<span id="cb1-1086"><a href="#cb1-1086"></a><span class="st">```</span>{r}</span>
<span id="cb1-1087"><a href="#cb1-1087"></a><span class="dv">1</span> <span class="sc">/</span> num_v_denom</span>
<span id="cb1-1088"><a href="#cb1-1088"></a><span class="st">```</span></span>
<span id="cb1-1089"><a href="#cb1-1089"></a></span>
<span id="cb1-1090"><a href="#cb1-1090"></a><span class="at">is very close to what we would expect? But I don't understand why at all.</span></span>
<span id="cb1-1091"><a href="#cb1-1091"></a></span>
<span id="cb1-1092"><a href="#cb1-1092"></a><span class="at">The other problem to debug this now here is that for the </span><span class="st">`</span>lme4<span class="st">`</span><span class="at"> model we have 11</span></span>
<span id="cb1-1093"><a href="#cb1-1093"></a><span class="at">variance parameters (one too much), whereas for </span><span class="st">`</span>glmmTMB<span class="st">`</span><span class="at"> we only have 10.</span></span>
<span id="cb1-1094"><a href="#cb1-1094"></a><span class="at">So we cannot easily transform the variance parameters into each other.</span></span>
<span id="cb1-1095"><a href="#cb1-1095"></a></span>
<span id="cb1-1096"><a href="#cb1-1096"></a><span class="at">The problem is that obviously the </span><span class="st">`</span>glmmTMB<span class="st">`</span><span class="at"> derived degrees of freedom are</span></span>
<span id="cb1-1097"><a href="#cb1-1097"></a><span class="at">wrong. We can e.g. have another comparison via simplified degrees of freedom:</span></span>
<span id="cb1-1098"><a href="#cb1-1098"></a></span>
<span id="cb1-1099"><a href="#cb1-1099"></a><span class="st">```</span>{r}</span>
<span id="cb1-1100"><a href="#cb1-1100"></a>simple_df <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(result<span class="sc">$</span>model<span class="sc">$</span>frame<span class="sc">$</span>USUBJID)) <span class="sc">-</span></span>
<span id="cb1-1101"><a href="#cb1-1101"></a>  Matrix<span class="sc">::</span><span class="fu">rankMatrix</span>(<span class="fu">model.matrix</span>(FEV1 <span class="sc">~</span> RACE <span class="sc">+</span> SEX <span class="sc">+</span> ARMCD <span class="sc">*</span> AVISIT, <span class="at">data =</span> dat))[<span class="dv">1</span>]</span>
<span id="cb1-1102"><a href="#cb1-1102"></a>simple_df</span>
<span id="cb1-1103"><a href="#cb1-1103"></a><span class="st">```</span></span>
<span id="cb1-1104"><a href="#cb1-1104"></a></span>
<span id="cb1-1105"><a href="#cb1-1105"></a><span class="at">which is at least in a similar ballpark.</span></span>
<span id="cb1-1106"><a href="#cb1-1106"></a></span>
<span id="cb1-1107"><a href="#cb1-1107"></a><span class="at">Temporary conclusion: It seems that </span><span class="st">`</span><span class="fu">h_covbeta_fun</span>()<span class="st">`</span><span class="at"> is not accurate enough.</span></span>
<span id="cb1-1108"><a href="#cb1-1108"></a><span class="at">We will replace this as soon as possible with an improved version. The flow</span></span>
<span id="cb1-1109"><a href="#cb1-1109"></a><span class="at">of the code and the other functions can stay however. Therefore we proceed</span></span>
<span id="cb1-1110"><a href="#cb1-1110"></a><span class="at">as planned.</span></span>
<span id="cb1-1111"><a href="#cb1-1111"></a></span>
<span id="cb1-1112"><a href="#cb1-1112"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_quad_form_mat</span>()<span class="st">`</span></span>
<span id="cb1-1113"><a href="#cb1-1113"></a></span>
<span id="cb1-1114"><a href="#cb1-1114"></a><span class="at">Just another helper to compute a quadratic form of a matrix and another matrix.</span></span>
<span id="cb1-1115"><a href="#cb1-1115"></a></span>
<span id="cb1-1116"><a href="#cb1-1116"></a><span class="st">```</span>{r}</span>
<span id="cb1-1117"><a href="#cb1-1117"></a><span class="co"># Calculates x %*% mat %*% t(x) efficiently if x is a matrix.</span></span>
<span id="cb1-1118"><a href="#cb1-1118"></a>h_quad_form_mat <span class="ot">&lt;-</span> <span class="cf">function</span>(x, mat) {</span>
<span id="cb1-1119"><a href="#cb1-1119"></a>  <span class="fu">assert_matrix</span>(x, <span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">any.missing =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-1120"><a href="#cb1-1120"></a>  <span class="fu">assert_matrix</span>(mat, <span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">any.missing =</span> <span class="cn">FALSE</span>, <span class="at">nrows =</span> <span class="fu">ncol</span>(x), <span class="at">ncols =</span> <span class="fu">ncol</span>(x))</span>
<span id="cb1-1121"><a href="#cb1-1121"></a>  x <span class="sc">%*%</span> <span class="fu">tcrossprod</span>(mat, x)</span>
<span id="cb1-1122"><a href="#cb1-1122"></a>}</span>
<span id="cb1-1123"><a href="#cb1-1123"></a></span>
<span id="cb1-1124"><a href="#cb1-1124"></a><span class="fu">h_quad_form_mat</span>(</span>
<span id="cb1-1125"><a href="#cb1-1125"></a>  <span class="at">x =</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb1-1126"><a href="#cb1-1126"></a>  <span class="at">mat =</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb1-1127"><a href="#cb1-1127"></a>)</span>
<span id="cb1-1128"><a href="#cb1-1128"></a><span class="st">```</span></span>
<span id="cb1-1129"><a href="#cb1-1129"></a></span>
<span id="cb1-1130"><a href="#cb1-1130"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_df_md_list</span>()<span class="st">`</span></span>
<span id="cb1-1131"><a href="#cb1-1131"></a></span>
<span id="cb1-1132"><a href="#cb1-1132"></a><span class="at">Little helper function to format results of </span><span class="st">`</span><span class="fu">df_md</span>()<span class="st">`</span><span class="at">.</span></span>
<span id="cb1-1133"><a href="#cb1-1133"></a></span>
<span id="cb1-1134"><a href="#cb1-1134"></a><span class="st">```</span>{r}</span>
<span id="cb1-1135"><a href="#cb1-1135"></a>h_df_md_list <span class="ot">&lt;-</span> <span class="cf">function</span>(f_stat, num_df, denom_df, <span class="at">scale =</span> <span class="dv">1</span>) {</span>
<span id="cb1-1136"><a href="#cb1-1136"></a>  f_stat <span class="ot">&lt;-</span> f_stat <span class="sc">*</span> scale</span>
<span id="cb1-1137"><a href="#cb1-1137"></a>  pval <span class="ot">&lt;-</span> <span class="fu">pf</span>(<span class="at">q =</span> f_stat, <span class="at">df1 =</span> num_df, <span class="at">df2 =</span> denom_df, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-1138"><a href="#cb1-1138"></a></span>
<span id="cb1-1139"><a href="#cb1-1139"></a>  <span class="fu">list</span>(</span>
<span id="cb1-1140"><a href="#cb1-1140"></a>    <span class="at">num_df =</span> num_df,</span>
<span id="cb1-1141"><a href="#cb1-1141"></a>    <span class="at">denom_df =</span> denom_df,</span>
<span id="cb1-1142"><a href="#cb1-1142"></a>    <span class="at">f_stat =</span> f_stat,</span>
<span id="cb1-1143"><a href="#cb1-1143"></a>    <span class="at">pval =</span> pval</span>
<span id="cb1-1144"><a href="#cb1-1144"></a>  )</span>
<span id="cb1-1145"><a href="#cb1-1145"></a>}</span>
<span id="cb1-1146"><a href="#cb1-1146"></a><span class="st">```</span></span>
<span id="cb1-1147"><a href="#cb1-1147"></a></span>
<span id="cb1-1148"><a href="#cb1-1148"></a><span class="at">## </span><span class="st">`</span><span class="fu">h_md_denom_df</span>()<span class="st">`</span></span>
<span id="cb1-1149"><a href="#cb1-1149"></a></span>
<span id="cb1-1150"><a href="#cb1-1150"></a><span class="at">This helper computes the denominator degrees of freedom for the F-statistic,</span></span>
<span id="cb1-1151"><a href="#cb1-1151"></a><span class="at">when derived from squared t-statistics. If the input values are two similar to</span></span>
<span id="cb1-1152"><a href="#cb1-1152"></a><span class="at">each other then just the average is returned.</span></span>
<span id="cb1-1153"><a href="#cb1-1153"></a></span>
<span id="cb1-1154"><a href="#cb1-1154"></a><span class="st">```</span>{r}</span>
<span id="cb1-1155"><a href="#cb1-1155"></a>h_md_denom_df <span class="ot">&lt;-</span> <span class="cf">function</span>(t_stat_df) {</span>
<span id="cb1-1156"><a href="#cb1-1156"></a>  <span class="fu">assert_numeric</span>(t_stat_df, <span class="at">min.len =</span> 1L, <span class="at">lower =</span> .Machine<span class="sc">$</span>double.xmin, <span class="at">any.missing =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-1157"><a href="#cb1-1157"></a>  <span class="cf">if</span> (<span class="fu">test_scalar</span>(t_stat_df)) {</span>
<span id="cb1-1158"><a href="#cb1-1158"></a>    <span class="fu">return</span>(t_stat_df)</span>
<span id="cb1-1159"><a href="#cb1-1159"></a>  }</span>
<span id="cb1-1160"><a href="#cb1-1160"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">abs</span>(<span class="fu">diff</span>(t_stat_df)) <span class="sc">&lt;</span> <span class="fl">1e-8</span>)) {</span>
<span id="cb1-1161"><a href="#cb1-1161"></a>    <span class="fu">return</span>(<span class="fu">mean</span>(t_stat_df))</span>
<span id="cb1-1162"><a href="#cb1-1162"></a>  }</span>
<span id="cb1-1163"><a href="#cb1-1163"></a>  <span class="cf">if</span> (<span class="fu">any</span>(t_stat_df <span class="sc">&lt;=</span> <span class="dv">2</span>)) {</span>
<span id="cb1-1164"><a href="#cb1-1164"></a>    <span class="dv">2</span></span>
<span id="cb1-1165"><a href="#cb1-1165"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-1166"><a href="#cb1-1166"></a>    E <span class="ot">&lt;-</span> <span class="fu">sum</span>(t_stat_df <span class="sc">/</span> (t_stat_df <span class="sc">-</span> <span class="dv">2</span>))</span>
<span id="cb1-1167"><a href="#cb1-1167"></a>    <span class="dv">2</span> <span class="sc">*</span> E <span class="sc">/</span> (E <span class="sc">-</span> (<span class="fu">length</span>(t_stat_df)))</span>
<span id="cb1-1168"><a href="#cb1-1168"></a>  }</span>
<span id="cb1-1169"><a href="#cb1-1169"></a>}</span>
<span id="cb1-1170"><a href="#cb1-1170"></a></span>
<span id="cb1-1171"><a href="#cb1-1171"></a><span class="fu">h_md_denom_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb1-1172"><a href="#cb1-1172"></a><span class="fu">h_md_denom_df</span>(<span class="fu">c</span>(<span class="fl">2.5</span>, <span class="fl">4.6</span>, <span class="fl">2.3</span>))</span>
<span id="cb1-1173"><a href="#cb1-1173"></a><span class="st">```</span></span>
<span id="cb1-1174"><a href="#cb1-1174"></a></span>
<span id="cb1-1175"><a href="#cb1-1175"></a><span class="at">## </span><span class="st">`</span><span class="fu">df_md</span>()<span class="st">`</span></span>
<span id="cb1-1176"><a href="#cb1-1176"></a></span>
<span id="cb1-1177"><a href="#cb1-1177"></a><span class="at">We define this function to calculate the Satterthwaite degrees of freedom for</span></span>
<span id="cb1-1178"><a href="#cb1-1178"></a><span class="at">the multi-dimensional case. It takes the </span><span class="st">`</span>mmrm<span class="st">`</span><span class="at"> object and the contrast matrix</span></span>
<span id="cb1-1179"><a href="#cb1-1179"></a><span class="at">(here vector).</span></span>
<span id="cb1-1180"><a href="#cb1-1180"></a></span>
<span id="cb1-1181"><a href="#cb1-1181"></a><span class="st">```</span>{r}</span>
<span id="cb1-1182"><a href="#cb1-1182"></a>df_md <span class="ot">&lt;-</span> <span class="cf">function</span>(object, L) {</span>
<span id="cb1-1183"><a href="#cb1-1183"></a>  <span class="fu">assert_class</span>(object, <span class="st">"mmrm"</span>)</span>
<span id="cb1-1184"><a href="#cb1-1184"></a>  <span class="fu">assert_numeric</span>(L, <span class="at">any.missing =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-1185"><a href="#cb1-1185"></a></span>
<span id="cb1-1186"><a href="#cb1-1186"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.matrix</span>(L)) {</span>
<span id="cb1-1187"><a href="#cb1-1187"></a>    L <span class="ot">&lt;-</span> <span class="fu">matrix</span>(L, <span class="at">ncol =</span> <span class="fu">length</span>(L))</span>
<span id="cb1-1188"><a href="#cb1-1188"></a>  }</span>
<span id="cb1-1189"><a href="#cb1-1189"></a>  <span class="fu">assert_matrix</span>(L, <span class="at">ncol =</span> <span class="fu">length</span>(object<span class="sc">$</span>beta_est))</span>
<span id="cb1-1190"><a href="#cb1-1190"></a></span>
<span id="cb1-1191"><a href="#cb1-1191"></a>  <span class="co"># Early return if we are in the one-dimensional case.</span></span>
<span id="cb1-1192"><a href="#cb1-1192"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(<span class="fu">nrow</span>(L), 1L)) {</span>
<span id="cb1-1193"><a href="#cb1-1193"></a>    res_1d <span class="ot">&lt;-</span> <span class="fu">df_1d</span>(object, L)</span>
<span id="cb1-1194"><a href="#cb1-1194"></a>    <span class="fu">return</span>(<span class="fu">h_df_md_list</span>(<span class="at">f_stat =</span> res_1d<span class="sc">$</span>t_stat<span class="sc">^</span><span class="dv">2</span>, <span class="at">num_df =</span> <span class="dv">1</span>, <span class="at">denom_df =</span> res_1d<span class="sc">$</span>df))</span>
<span id="cb1-1195"><a href="#cb1-1195"></a>  }</span>
<span id="cb1-1196"><a href="#cb1-1196"></a></span>
<span id="cb1-1197"><a href="#cb1-1197"></a>  contrast_cov <span class="ot">&lt;-</span> <span class="fu">h_quad_form_mat</span>(L, object<span class="sc">$</span>vcov_beta)</span>
<span id="cb1-1198"><a href="#cb1-1198"></a>  eigen_cont_cov <span class="ot">&lt;-</span> <span class="fu">eigen</span>(contrast_cov)</span>
<span id="cb1-1199"><a href="#cb1-1199"></a>  eigen_cont_cov_vctrs <span class="ot">&lt;-</span> eigen_cont_cov<span class="sc">$</span>vectors</span>
<span id="cb1-1200"><a href="#cb1-1200"></a>  eigen_cont_cov_vals <span class="ot">&lt;-</span> eigen_cont_cov<span class="sc">$</span>values</span>
<span id="cb1-1201"><a href="#cb1-1201"></a></span>
<span id="cb1-1202"><a href="#cb1-1202"></a>  eps <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(.Machine<span class="sc">$</span>double.eps)</span>
<span id="cb1-1203"><a href="#cb1-1203"></a>  tol <span class="ot">&lt;-</span> <span class="fu">max</span>(eps <span class="sc">*</span> eigen_cont_cov_vals[<span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb1-1204"><a href="#cb1-1204"></a>  rank_cont_cov <span class="ot">&lt;-</span> <span class="fu">sum</span>(eigen_cont_cov_vals <span class="sc">&gt;</span> tol)</span>
<span id="cb1-1205"><a href="#cb1-1205"></a>  <span class="fu">assert_number</span>(rank_cont_cov, <span class="at">lower =</span> .Machine<span class="sc">$</span>double.xmin)</span>
<span id="cb1-1206"><a href="#cb1-1206"></a>  rank_seq <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(rank_cont_cov)</span>
<span id="cb1-1207"><a href="#cb1-1207"></a>  vctrs_cont_prod <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(eigen_cont_cov_vctrs, L)[rank_seq, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb1-1208"><a href="#cb1-1208"></a></span>
<span id="cb1-1209"><a href="#cb1-1209"></a>  <span class="co"># Early return if rank 1.</span></span>
<span id="cb1-1210"><a href="#cb1-1210"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(rank_cont_cov, 1L)) {</span>
<span id="cb1-1211"><a href="#cb1-1211"></a>    res_1d <span class="ot">&lt;-</span> <span class="fu">df_1d</span>(object, L)</span>
<span id="cb1-1212"><a href="#cb1-1212"></a>    <span class="fu">return</span>(<span class="fu">h_df_md_list</span>(<span class="at">f_stat =</span> res_1d<span class="sc">$</span>t_stat<span class="sc">^</span><span class="dv">2</span>, <span class="at">num_df =</span> <span class="dv">1</span>, <span class="at">denom_df =</span> res_1d<span class="sc">$</span>df))</span>
<span id="cb1-1213"><a href="#cb1-1213"></a>  }</span>
<span id="cb1-1214"><a href="#cb1-1214"></a></span>
<span id="cb1-1215"><a href="#cb1-1215"></a>  t_squared_nums <span class="ot">&lt;-</span> <span class="fu">drop</span>(vctrs_cont_prod <span class="sc">%*%</span> result<span class="sc">$</span>beta_est)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-1216"><a href="#cb1-1216"></a>  t_squared_denoms <span class="ot">&lt;-</span> eigen_cont_cov_vals[rank_seq]</span>
<span id="cb1-1217"><a href="#cb1-1217"></a>  t_squared <span class="ot">&lt;-</span> t_squared_nums <span class="sc">/</span> t_squared_denoms</span>
<span id="cb1-1218"><a href="#cb1-1218"></a>  f_stat <span class="ot">&lt;-</span> <span class="fu">sum</span>(t_squared) <span class="sc">/</span> rank_cont_cov</span>
<span id="cb1-1219"><a href="#cb1-1219"></a>  grads_vctrs_cont_prod <span class="ot">&lt;-</span> <span class="fu">lapply</span>(rank_seq, \(m) <span class="fu">h_gradient</span>(result<span class="sc">$</span>jac_list, <span class="at">L =</span> vctrs_cont_prod[m, ]))</span>
<span id="cb1-1220"><a href="#cb1-1220"></a>  t_stat_df_nums <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> eigen_cont_cov_vals<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-1221"><a href="#cb1-1221"></a>  t_stat_df_denoms <span class="ot">&lt;-</span> <span class="fu">vapply</span>(grads_vctrs_cont_prod, h_quad_form_vec, <span class="at">mat =</span> object<span class="sc">$</span>vcov_theta, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb1-1222"><a href="#cb1-1222"></a>  t_stat_df <span class="ot">&lt;-</span> t_stat_df_nums <span class="sc">/</span> t_stat_df_denoms</span>
<span id="cb1-1223"><a href="#cb1-1223"></a>  denom_df <span class="ot">&lt;-</span> <span class="fu">h_md_denom_df</span>(t_stat_df)</span>
<span id="cb1-1224"><a href="#cb1-1224"></a></span>
<span id="cb1-1225"><a href="#cb1-1225"></a>  <span class="fu">h_df_md_list</span>(</span>
<span id="cb1-1226"><a href="#cb1-1226"></a>    <span class="at">f_stat =</span> f_stat,</span>
<span id="cb1-1227"><a href="#cb1-1227"></a>    <span class="at">num_df =</span> rank_cont_cov,</span>
<span id="cb1-1228"><a href="#cb1-1228"></a>    <span class="at">denom_df =</span> denom_df</span>
<span id="cb1-1229"><a href="#cb1-1229"></a>  )</span>
<span id="cb1-1230"><a href="#cb1-1230"></a>}</span>
<span id="cb1-1231"><a href="#cb1-1231"></a></span>
<span id="cb1-1232"><a href="#cb1-1232"></a>L2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb1-1233"><a href="#cb1-1233"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb1-1234"><a href="#cb1-1234"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb1-1235"><a href="#cb1-1235"></a>)</span>
<span id="cb1-1236"><a href="#cb1-1236"></a><span class="fu">df_md</span>(result, L2)</span>
<span id="cb1-1237"><a href="#cb1-1237"></a><span class="fu">df_md</span>(result, L)</span>
<span id="cb1-1238"><a href="#cb1-1238"></a><span class="st">```</span></span>
<span id="cb1-1239"><a href="#cb1-1239"></a></span>
<span id="cb1-1240"><a href="#cb1-1240"></a><span class="at">## </span><span class="st">`</span>recover_data<span class="st">`</span><span class="at"> method</span></span>
<span id="cb1-1241"><a href="#cb1-1241"></a></span>
<span id="cb1-1242"><a href="#cb1-1242"></a><span class="at">Here the idea is that we just forward directly to the </span><span class="st">`</span>glmmTMB<span class="st">`</span><span class="at"> method so</span></span>
<span id="cb1-1243"><a href="#cb1-1243"></a><span class="at">that we don't have to do anything ourselves.</span></span>
<span id="cb1-1244"><a href="#cb1-1244"></a></span>
<span id="cb1-1245"><a href="#cb1-1245"></a><span class="st">```</span>{r}</span>
<span id="cb1-1246"><a href="#cb1-1246"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb1-1247"><a href="#cb1-1247"></a>recover_data.mmrm <span class="ot">&lt;-</span> <span class="cf">function</span>(object, ...) {</span>
<span id="cb1-1248"><a href="#cb1-1248"></a>  component <span class="ot">&lt;-</span> <span class="st">"cond"</span></span>
<span id="cb1-1249"><a href="#cb1-1249"></a>  emmeans<span class="sc">::</span><span class="fu">recover_data</span>(object<span class="sc">$</span>model, <span class="at">component =</span> <span class="st">"cond"</span>, ...)</span>
<span id="cb1-1250"><a href="#cb1-1250"></a>}</span>
<span id="cb1-1251"><a href="#cb1-1251"></a><span class="st">```</span></span>
<span id="cb1-1252"><a href="#cb1-1252"></a></span>
<span id="cb1-1253"><a href="#cb1-1253"></a><span class="at">Let's try if this does something.</span></span>
<span id="cb1-1254"><a href="#cb1-1254"></a></span>
<span id="cb1-1255"><a href="#cb1-1255"></a><span class="st">```</span>{r}</span>
<span id="cb1-1256"><a href="#cb1-1256"></a>test <span class="ot">&lt;-</span> <span class="fu">recover_data</span>(result)</span>
<span id="cb1-1257"><a href="#cb1-1257"></a><span class="fu">class</span>(test)</span>
<span id="cb1-1258"><a href="#cb1-1258"></a><span class="fu">dim</span>(test)</span>
<span id="cb1-1259"><a href="#cb1-1259"></a><span class="st">```</span></span>
<span id="cb1-1260"><a href="#cb1-1260"></a></span>
<span id="cb1-1261"><a href="#cb1-1261"></a><span class="at">So that seems to work fine.</span></span>
<span id="cb1-1262"><a href="#cb1-1262"></a></span>
<span id="cb1-1263"><a href="#cb1-1263"></a><span class="at">## </span><span class="st">`</span>emm_basis<span class="st">`</span><span class="at"> method</span></span>
<span id="cb1-1264"><a href="#cb1-1264"></a></span>
<span id="cb1-1265"><a href="#cb1-1265"></a><span class="at">Also here the majority of the work can be done by the </span><span class="st">`</span>glmmTMB<span class="st">`</span><span class="at"> method.</span></span>
<span id="cb1-1266"><a href="#cb1-1266"></a><span class="at">We just need to replace the </span><span class="st">`</span>dffun<span class="st">`</span><span class="at"> and </span><span class="st">`</span>dfargs<span class="st">`</span><span class="at"> in the list that is returned</span></span>
<span id="cb1-1267"><a href="#cb1-1267"></a><span class="at">by that before returning ourselves. For this we look at the </span><span class="st">`</span>merMod<span class="st">`</span><span class="at"> method in</span></span>
<span id="cb1-1268"><a href="#cb1-1268"></a><span class="st">`</span>emmeans<span class="st">`</span><span class="at"> (https://github.com/rvlenth/emmeans/blob/0af291a78eaecb9e22f45b5ec064474f5f5ed61a/R/helpers.R#L192).</span></span>
<span id="cb1-1269"><a href="#cb1-1269"></a></span>
<span id="cb1-1270"><a href="#cb1-1270"></a><span class="st">```</span>{r}</span>
<span id="cb1-1271"><a href="#cb1-1271"></a>emm_basis.mmrm <span class="ot">&lt;-</span> <span class="cf">function</span>(object, trms, xlev, grid, vcov., ...) {</span>
<span id="cb1-1272"><a href="#cb1-1272"></a>  res <span class="ot">&lt;-</span> <span class="fu">emm_basis</span>(object<span class="sc">$</span>model, <span class="at">trms =</span> trms, <span class="at">xlev =</span> xlev, <span class="at">grid =</span> grid, <span class="at">vcov. =</span> vcov., <span class="at">component =</span> <span class="st">"cond"</span>, ...)</span>
<span id="cb1-1273"><a href="#cb1-1273"></a>  dfargs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">object =</span> object)</span>
<span id="cb1-1274"><a href="#cb1-1274"></a>  dffun <span class="ot">&lt;-</span> <span class="cf">function</span>(k, dfargs) {</span>
<span id="cb1-1275"><a href="#cb1-1275"></a>    <span class="co"># Note: Once this is `df_md` function is in the package we can just get</span></span>
<span id="cb1-1276"><a href="#cb1-1276"></a>    <span class="co"># it from there instead from global environment.</span></span>
<span id="cb1-1277"><a href="#cb1-1277"></a>    <span class="fu">get</span>(<span class="st">"df_md"</span>, <span class="at">envir =</span> <span class="fu">globalenv</span>())(dfargs<span class="sc">$</span>object, k)<span class="sc">$</span>denom_df</span>
<span id="cb1-1278"><a href="#cb1-1278"></a>  }</span>
<span id="cb1-1279"><a href="#cb1-1279"></a>  res<span class="sc">$</span>dfargs <span class="ot">&lt;-</span> dfargs</span>
<span id="cb1-1280"><a href="#cb1-1280"></a>  res<span class="sc">$</span>dffun <span class="ot">&lt;-</span> dffun</span>
<span id="cb1-1281"><a href="#cb1-1281"></a>  res</span>
<span id="cb1-1282"><a href="#cb1-1282"></a>}</span>
<span id="cb1-1283"><a href="#cb1-1283"></a><span class="st">```</span></span>
<span id="cb1-1284"><a href="#cb1-1284"></a></span>
<span id="cb1-1285"><a href="#cb1-1285"></a><span class="at">Now let's see if we can use </span><span class="st">`</span>emmeans<span class="st">`</span><span class="at"> on the </span><span class="st">`</span>mmrm<span class="st">`</span><span class="at"> object:</span></span>
<span id="cb1-1286"><a href="#cb1-1286"></a></span>
<span id="cb1-1287"><a href="#cb1-1287"></a><span class="st">```</span>{r}</span>
<span id="cb1-1288"><a href="#cb1-1288"></a>emm_obj <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(result, <span class="fu">c</span>(<span class="st">"ARMCD"</span>, <span class="st">"AVISIT"</span>), <span class="at">data =</span> dat)</span>
<span id="cb1-1289"><a href="#cb1-1289"></a>emm_obj</span>
<span id="cb1-1290"><a href="#cb1-1290"></a><span class="st">```</span></span>
<span id="cb1-1291"><a href="#cb1-1291"></a></span>
<span id="cb1-1292"><a href="#cb1-1292"></a><span class="at">So that gives different result than calling directly the </span><span class="st">`</span>glmmTMB<span class="st">`</span><span class="at"> method:</span></span>
<span id="cb1-1293"><a href="#cb1-1293"></a></span>
<span id="cb1-1294"><a href="#cb1-1294"></a><span class="st">```</span>{r}</span>
<span id="cb1-1295"><a href="#cb1-1295"></a>emm_obj2 <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(result<span class="sc">$</span>model, <span class="fu">c</span>(<span class="st">"ARMCD"</span>, <span class="st">"AVISIT"</span>), <span class="at">data =</span> dat)</span>
<span id="cb1-1296"><a href="#cb1-1296"></a>emm_obj2</span>
<span id="cb1-1297"><a href="#cb1-1297"></a><span class="st">```</span></span>
<span id="cb1-1298"><a href="#cb1-1298"></a></span>
<span id="cb1-1299"><a href="#cb1-1299"></a><span class="at">So our own degrees of freedom are used successfully!</span></span>
<span id="cb1-1300"><a href="#cb1-1300"></a></span>
<span id="cb1-1301"><a href="#cb1-1301"></a><span class="at">Based on this we can then calculate any least square means, e.g.:</span></span>
<span id="cb1-1302"><a href="#cb1-1302"></a></span>
<span id="cb1-1303"><a href="#cb1-1303"></a><span class="st">```</span>{r}</span>
<span id="cb1-1304"><a href="#cb1-1304"></a><span class="fu">pairs</span>(emm_obj)</span>
<span id="cb1-1305"><a href="#cb1-1305"></a><span class="st">```</span></span>
<span id="cb1-1306"><a href="#cb1-1306"></a></span>
<span id="cb1-1307"><a href="#cb1-1307"></a><span class="at">Note that we have numerical problems here because of the wrong Satterthwaite</span></span>
<span id="cb1-1308"><a href="#cb1-1308"></a><span class="at">calculations at this point. But all this will be fixed when </span><span class="st">`</span><span class="fu">h_covbeta_fun</span>()<span class="st">`</span></span>
<span id="cb1-1309"><a href="#cb1-1309"></a><span class="at">is fixed.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="example-mmrm-contd" class="slide level2">
<h2>Example: <code>mmrm</code> (cont’d)</h2>
<ul>
<li>Have separate issues and corresponding pull requests implementing functions</li>
</ul>

<img data-src="resources/issues.png" class="r-stretch"></section></section>
<section>
<section id="assume-your-r-package-is-evolving-for-a-long-time" class="title-slide slide level1 center">
<h1>Assume your R-package is evolving for a long time</h1>

</section>
<section id="why-should-we-document-the-methods" class="slide level2">
<h2>Why should we document the methods?</h2>
<ul>
<li>It is important to add method documentation in your package, typically as a vignette</li>
<li>This provides the “glue” between the original methods paper and your implementation in code
<ul>
<li>different mathematical symbols compared to original paper but that match the code variable names</li>
<li>specific details on the algorithm</li>
</ul></li>
<li>Users benefit from this method documentation a lot because they can understand what is going on in your package</li>
<li>Developers will depend on the method documentation when adding new method features and to understand the code</li>
</ul>
</section>
<section id="why-do-we-need-tests" class="slide level2">
<h2>Why do we need tests?</h2>
<ul>
<li>It is 100% guaranteed that users will have new feature requests after the first version of the R package has been released
<ul>
<li>This is a good sign - the package is being used and your users have good ideas!</li>
</ul></li>
<li>It is also very likely that some of the packages you depend on will change - but you want to be sure your package still works
<ul>
<li>incl.&nbsp;integration tests, making sure numerical results are still correct</li>
</ul></li>
<li>So you will need to change the code …
<ul>
<li>… but you can only do that comfortably if you know that the package still works afterwards</li>
<li>If the tests pass you know it still works!</li>
</ul></li>
</ul>
</section>
<section id="how-can-i-make-the-package-extensible" class="slide level2">
<h2>How can I make the package extensible?</h2>
<ul>
<li>“Extensible” = others can extend it without changing package code</li>
<li>You want to make your package extensible so that you or other developers can easily extend it</li>
<li>Prefer to combine multiple functions in pipelines (similar as typically done in tidyverse)</li>
<li>Prefer object oriented package designs because it will help a lot the extensibility</li>
<li>Generally avoid functions with many arguments or longer than 50 lines of code</li>
</ul>
</section>
<section id="example-mmrm---method-documentation" class="slide level2">
<h2>Example: <code>mmrm</code> - method documentation</h2>
<ul>
<li>Started with handwritten notes of the algorithm implementation for the prototype</li>
<li>Translated that into vignette</li>
<li>Has been updated many times already when algorithm was updated</li>
<li>Meanwhile have in total 12 different vignettes on different aspects</li>
</ul>
</section>
<section id="section" class="slide level2" data-background-iframe="https://openpharma.github.io/mmrm/latest-tag/articles/algorithm.html" data-background-interactive="true">
<h2></h2>
</section>
<section id="example-mmrm---tests" class="slide level2">
<h2>Example: <code>mmrm</code> - tests</h2>
<ul>
<li>Add tests, code documentation and method documentation during each pull request for each function
<ul>
<li>Add integration tests comparing numerical results with numbers sourced from proprietary software</li>
<li>Some tests can take longer, if run time becomes an issue can skip them on CRAN</li>
</ul></li>
<li>Turned out tests were super important because minor <code>C++</code> changes could break results on different operating system</li>
</ul>
</section>
<section id="example-mmrm---extensibility" class="slide level2">
<h2>Example: <code>mmrm</code> - extensibility</h2>
<ul>
<li>This is a typical “model fitting” package and therefore we use the S3 class system
<ul>
<li>Over time can add interfaces to other modeling packages (more later)</li>
</ul></li>
</ul>
</section></section>
<section>
<section id="introduction-to-the-mmrm-package" class="title-slide slide level1 center">
<h1>Introduction to the <code>mmrm</code> package</h1>

</section>
<section id="installation" class="slide level2">
<h2>Installation</h2>
<ul>
<li>CRAN as usual: <code>install.packages("mmrm")</code>
<ul>
<li>Lags a bit behind at the moment (due to CRAN manual review bottleneck)</li>
</ul></li>
<li>GitHub as usual: <code>remotes::install_github("openpharma/mmrm")</code>
<ul>
<li>But needs <code>C++</code> toolchain and can take quite a while to compile</li>
</ul></li>
<li>R-Universe: <a href="https://openpharma.r-universe.dev/mmrm">https://openpharma.r-universe.dev/mmrm</a> and download the binary package and install afterwards
<ul>
<li>Somehow the <code>install.packages()</code> path from R does not find the binaries</li>
</ul></li>
</ul>
</section>
<section id="features-of-mmrm-0.3" class="slide level2">
<h2>Features of <code>mmrm</code> (&gt;= 0.3)</h2>
<ul>
<li>Linear model for dependent observations within independent subjects</li>
<li>Covariance structures for the dependent observations:
<ul>
<li>Unstructured, Toeplitz, AR1, compound symmetry, ante-dependence, spatial exponential</li>
<li>Allows group specific covariance estimates and weights</li>
</ul></li>
<li>REML or ML estimation, using multiple optimizers if needed</li>
<li>Robust sandwich estimator for covariance</li>
<li>Degrees of freedom adjustments: Satterthwaite, Kenward-Roger, Kenward-Roger-Linear, Between-Within, Residual</li>
</ul>
</section>
<section id="ecosystem-integration" class="slide level2">
<h2>Ecosystem integration</h2>
<ul>
<li><code>emmeans</code> interface for least square means</li>
<li><code>tidymodels</code> for easy model fitting:
<ul>
<li>Dedicated <code>parsnip</code> engine for linear regression</li>
<li>Integration with <code>recipes</code></li>
</ul></li>
<li>NEST family for clinical trial reporting:
<ul>
<li><code>tern.mmrm</code> to easily generate common tables and plot (coming to CRAN soon)</li>
<li><code>teal.modules.clinical</code> to easily spin up Shiny app based on the <code>teal</code> framework (coming to CRAN soon)</li>
</ul></li>
<li>Provided by third party packages (remember the extensibility discussion):
<ul>
<li>interfaces to <code>insight</code>, <code>parameters</code></li>
</ul></li>
</ul>
</section>
<section id="unit-and-integration-testing" class="slide level2">
<h2>Unit and integration testing</h2>
<ul>
<li>Unit tests can be found in the GitHub repository under <a href="https://github.com/openpharma/mmrm/tree/main/tests/testthat">./tests</a>.</li>
<li>Uses the <code>testthat</code> framework with <code>covr</code> to communicate the testing coverage.
<ul>
<li>Coverage above 95%</li>
<li>Also include tests for key <code>C++</code> functions</li>
</ul></li>
<li>The integration tests in <code>mmrm</code> are set to a standard tolerance of <span class="math inline">\(10^{-3}\)</span> when compared to other software outputs
<ul>
<li>Comparison with SAS results (<code>PROC MIXED</code>)</li>
<li>Comparison with relevant R packages</li>
</ul></li>
</ul>
</section>
<section id="benchmarking-with-other-r-packages" class="slide level2">
<h2>Benchmarking with other R packages</h2>
<ul>
<li>Compared <code>mmrm::mmrm</code> with <code>nlme::gls</code>, <code>lme4::lmer</code>, <code>glmmTMB::glmmTMB</code></li>
<li>Highlights:
<ul>
<li><code>mmrm</code> has faster convergence time
<ul>
<li>Using <code>FEV</code> dataset as an example, <code>mmrm</code> took ~50 ms, while <code>lmer</code> ~200 ms, <code>gls</code> and <code>glmmTMB</code> &gt;600 ms</li>
</ul></li>
<li><code>mmrm</code> and <code>gls</code> estimates have smaller differences from SAS <code>PROC GLIMMIX</code> estimates</li>
<li><code>mmrm</code> and <code>gls</code> are more resilient to missingness</li>
</ul></li>
<li>Detailed results at the online <a href="https://openpharma.github.io/mmrm/main/articles/mmrm_review_methods.html">comparison vignette</a></li>
</ul>
</section>
<section id="impact-of-mmrm" class="slide level2">
<h2>Impact of <code>mmrm</code></h2>
<ul>
<li>CRAN downloads: around 100 per day in Oct 2023
<ul>
<li><a href="https://cran.r-project.org/web/packages/mmrm/">https://cran.r-project.org/web/packages/mmrm/</a></li>
<li>new CRAN release v0.3 coming any day now!</li>
</ul></li>
<li>GitHub repository: 73 stars as of 17 Oct 2023
<ul>
<li><a href="https://github.com/openpharma/mmrm">https://github.com/openpharma/mmrm</a></li>
</ul></li>
<li>Part of CRAN clinical trials task view</li>
</ul>
</section>
<section id="outlook" class="slide level2">
<h2>Outlook</h2>
<ul>
<li><code>mmrm</code> is now relatively complete for mostly needed features</li>
<li>We still have a few major ideas on our backlog:
<ul>
<li>Type II and Type III ANOVA tests</li>
<li>Evaluate adding (simple) random effects</li>
</ul></li>
<li>Please let us know what is missing in <code>mmrm</code> for you!</li>
</ul>
</section></section>
<section>
<section id="hands-on-demo-time" class="title-slide slide level1 center">
<h1>Hands-On Demo Time!</h1>

</section>
<section id="demo-instructions" class="slide level2">
<h2>Demo Instructions</h2>
<p>Doug can you include here basic instructions (maybe screenshot if needed) how folks can log into the Posit cloud for the demo?</p>
</section></section>
<section>
<section id="open-source-development-across-companies" class="title-slide slide level1 center">
<h1>Open source development across companies</h1>

</section>
<section id="introducing-openstatsware" class="slide level2">
<h2>Introducing <code>openstatsware</code></h2>
<div class="columns">
<div class="column" style="width:70%;">
<p>Founded last year:</p>
<ul>
<li>When: 19 August 2022 - just celebrated our 1 year birthday!</li>
<li>Where: American Statistical Association (ASA) Biopharmaceutical Section (BIOP)</li>
<li>Initially: 11 statisticians from 7 pharma companies developing statistical software</li>
<li>New name: <code>openstatsware</code></li>
</ul>
</div><div class="column" style="width:30%;">
<p><img data-src="https://github.com/RConsortium/asa-biop-swe-wg/raw/main/sticker/sticker-new-1200.png" height="300"></p>
</div>
</div>
</section>
<section id="mmrm-was-our-first-workstream" class="slide level2">
<h2><code>mmrm</code> was our first workstream</h2>
<ul>
<li>Why is the MMRM topic important?
<ul>
<li>MMRM is a popular analysis method for longitudinal continuous outcomes in randomized clinical trials</li>
<li>Also used as backbone for more recent methods such as multiple imputation</li>
</ul></li>
<li>See also our second workstream that produced <a href="https://openpharma.github.io/brms.mmrm/"><code>brms.mmrm</code></a>
<ul>
<li>Bayesian inference in MMRM, based on <code>brms</code> (as Stan frontend for HMC sampling)</li>
</ul></li>
</ul>
</section>
<section id="human-success-factors" class="slide level2">
<h2>Human success factors</h2>
<ul>
<li>Mutual interest and mutual trust</li>
<li>Prerequisite is getting to know each other
<ul>
<li>Although mostly just online, biweekly calls help a lot with this</li>
</ul></li>
<li>Reciprocity mindset
<ul>
<li>“Reciprocity means that in response to friendly actions, people are frequently much nicer and much more cooperative than predicted by the self-interest model”</li>
<li>Personal experience: If you first give away something, more will come back to you.</li>
</ul></li>
</ul>
</section>
<section id="be-inclusive-in-the-development" class="slide level2">
<h2>Be inclusive in the development</h2>
<ul>
<li>Important to go public as soon as possible
<ul>
<li>We did not wait for <code>mmrm</code> to be finished before initial open sourcing</li>
<li>Many developers contributed over time</li>
</ul></li>
<li>Building software together works better than alone
<ul>
<li>Different perspectives in discussions and code review help to optimize the user interface and thus experience</li>
<li>Be generous with authorship</li>
</ul></li>
</ul>
</section>
<section id="practical-daily-development-process" class="slide level2">
<h2>Practical daily development process</h2>
<p>Doug would you like to add here a few slides?</p>

<div class="footer footer-default">
<p>From the statistical method to the R package - the <code>mmrm</code> example | <a href="http://creativecommons.org/licenses/by-sa/4.0/" title="License: CC BY-SA 4.0">License</a></p>
</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'smaller': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button', {
        text: function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
      });
      clipboard.on('success', function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      });
      function tippyHover(el, contentFn) {
        const config = {
          allowHTML: true,
          content: contentFn,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        };
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          return note.innerHTML;
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>